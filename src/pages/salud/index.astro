---
import MainLayout from '../../layouts/MainLayout.astro';
import SaludTabs from '../../components/SaludTabs.astro';
import { getActivePet } from '../../lib/pet';
import { calculateVitalityScore } from '../../lib/vitality-score';
import type { ScoreInput } from '../../lib/vitality-score';

const { supabase, user, activePetId } = Astro.locals;
const { pet } = await getActivePet(supabase, user.id, activePetId);

if (!pet) return Astro.redirect('/onboarding');

const [
  { data: weightRecords },
  { data: vaccines },
  { data: vetVisits },
  { data: groomings },
  { data: adventures },
  { data: foods },
] = await Promise.all([
  supabase.from('weight_records').select('weight_kg, date').eq('pet_id', pet.id).order('date', { ascending: false }),
  supabase.from('vaccines').select('name, date_given').eq('pet_id', pet.id).order('date_given', { ascending: false }),
  supabase.from('vet_visits').select('visit_date').eq('pet_id', pet.id).order('visit_date', { ascending: false }),
  supabase.from('groomings').select('date').eq('pet_id', pet.id).order('date', { ascending: false }),
  supabase.from('adventures').select('date').eq('pet_id', pet.id).order('date', { ascending: false }),
  supabase.from('foods').select('brand, daily_grams, bag_size, bag_unit, food_type').eq('pet_id', pet.id).order('created_at', { ascending: false }),
]);

const scoreInput: ScoreInput = {
  pet: {
    breed: pet.breed ?? null,
    birth_date: pet.birth_date ?? null,
    weight_kg: pet.weight_kg ?? null,
    gender: pet.gender ?? null,
    is_neutered: (pet as any).is_neutered ?? null,
  },
  weightRecords: weightRecords ?? [],
  vaccines: vaccines ?? [],
  vetVisits: vetVisits ?? [],
  groomings: groomings ?? [],
  adventures: adventures ?? [],
  foods: foods ?? [],
};

const score = calculateVitalityScore(scoreInput);

// Gauge SVG — arco de 270°
const R = 44;
const FULL_ARC = Math.PI * R * 270 / 180;
const filled = (score.total / 100) * FULL_ARC;
---

<MainLayout title="Salud">

  <SaludTabs />

  {/* ── HEADER ── */}
  <div class="mb-5 animate-fade-up">
    <h1 class="text-2xl font-black text-ink tracking-tight">Salud</h1>
    <p class="text-sm text-muted mt-0.5">{pet.name} · Vitality Score</p>
  </div>

  {/* ── VITALITY SCORE HERO ── */}
  <div class="rounded-2xl bg-card border border-card-border p-5 mb-4 animate-fade-up">

    {/* Gauge */}
    <div class="flex flex-col items-center mb-4">
      <svg viewBox="0 0 120 80" class="w-48 overflow-visible" aria-hidden="true">
        <path
          d="M 16 74 A 44 44 0 1 1 104 74"
          fill="none"
          stroke="#EAECF0"
          stroke-width="10"
          stroke-linecap="round"
        />
        <path
          d="M 16 74 A 44 44 0 1 1 104 74"
          fill="none"
          stroke={score.color}
          stroke-width="10"
          stroke-linecap="round"
          stroke-dasharray={`${filled.toFixed(1)} ${FULL_ARC.toFixed(1)}`}
        />
        <text x="60" y="62" text-anchor="middle" font-size="22" font-weight="900" fill="#0F1117" font-family="system-ui">{score.total}</text>
        <text x="60" y="74" text-anchor="middle" font-size="7" fill="#6B7280" font-family="system-ui">de 100</text>
      </svg>
      <p class="text-base font-bold mt-2" style={`color: ${score.color};`}>{score.headline}</p>
      <p class="text-xs text-muted mt-0.5 text-center">{score.subline}</p>
    </div>

    {/* Pilares — siempre visibles */}
    <div class="pt-3 border-t border-card-border">
      <p class="text-[11px] font-semibold text-muted uppercase tracking-widest mb-2.5 text-center">{score.pilarsWithData}/5 áreas con datos</p>
      <div class="space-y-1.5">
        {score.pillars.map(pillar => (
          <div
            class:list={[
              'flex items-center gap-3 rounded-xl px-3 py-2 transition-colors',
              pillar.isEstimated
                ? 'bg-canvas border border-dashed border-card-border'
                : 'bg-accent/10 border border-transparent',
            ]}
          >
            <span class="text-base shrink-0">{pillar.emoji}</span>
            <div class="flex-1 min-w-0">
              <p class:list={['text-xs font-semibold', pillar.isEstimated ? 'text-muted' : 'text-ink']}>{pillar.name}</p>
              <p class="text-[11px] text-muted truncate">{pillar.status}</p>
            </div>
            {pillar.isEstimated ? (
              <div class="shrink-0 h-5 w-5 rounded-full border-2 border-dashed border-card-border flex items-center justify-center">
                <div class="h-1.5 w-1.5 rounded-full bg-muted/40" />
              </div>
            ) : (
              <div class="shrink-0 h-5 w-5 rounded-full bg-accent flex items-center justify-center">
                <svg class="h-3 w-3 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M20 6 9 17l-5-5"/></svg>
              </div>
            )}
          </div>
        ))}
      </div>
    </div>

  </div>

  {/* ── ACCESOS RÁPIDOS ── */}
  <div class="grid grid-cols-2 gap-3 mb-4 animate-fade-up animate-fade-up-delay-1">

    <a href="/salud/vacunas" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all hover:border-accent/30 active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-accent/10">
        <svg class="h-4 w-4 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Vacunas</p>
        <p class="text-[11px] text-muted">Historial y próximas</p>
      </div>
    </a>

    <a href="/salud/historial" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all hover:border-blue-200 active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-blue-50">
        <svg class="h-4 w-4 text-blue-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Historial Vet.</p>
        <p class="text-[11px] text-muted">Citas y consultas</p>
      </div>
    </a>

    <a href="/salud/peso" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all hover:border-sky-200 active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-sky-50">
        <svg class="h-4 w-4 text-sky-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Peso</p>
        <p class="text-[11px] text-muted">Historial y tendencia</p>
      </div>
    </a>

    <a href="/salud/grooming" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all hover:border-pink-200 active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-pink-50">
        <svg class="h-4 w-4 text-pink-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2z"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Grooming</p>
        <p class="text-[11px] text-muted">Baños y estética</p>
      </div>
    </a>

  </div>

  {/* ── RECOMENDACIONES ── */}
  {score.flags.length > 0 && (
    <div class="mb-4 animate-fade-up animate-fade-up-delay-2">
      <p class="text-xs font-semibold text-muted uppercase tracking-widest mb-3">Recomendaciones</p>
      <div class="space-y-2">
        {score.flags.slice(0, 3).map(flag => {
          const issuggestion = flag.severity === 'suggestion';
          const isreminder = flag.severity === 'reminder';
          return (
            <a
              href={flag.href}
              class:list={[
                'flex items-start gap-3 rounded-2xl border p-4 transition-all active:scale-95',
                issuggestion ? 'border-amber-200 bg-amber-50' : isreminder ? 'border-blue-200 bg-blue-50' : 'border-card-border bg-card',
              ]}
            >
              <div class:list={[
                'mt-1.5 h-2 w-2 shrink-0 rounded-full',
                issuggestion ? 'bg-amber-400' : isreminder ? 'bg-blue-400' : 'bg-muted/50',
              ]} />
              <div class="flex-1 min-w-0">
                <p class:list={[
                  'text-xs font-medium leading-snug',
                  issuggestion ? 'text-amber-800' : isreminder ? 'text-blue-700' : 'text-ink',
                ]}>{flag.message}</p>
                <p class="text-[11px] text-muted mt-0.5">{flag.action} →</p>
              </div>
            </a>
          );
        })}
      </div>
    </div>
  )}

  {/* ── DISCLAIMER ── */}
  <div class="mt-2 mb-4 animate-fade-up animate-fade-up-delay-2">
    <p class="text-[11px] text-muted text-center leading-relaxed">
      El Vitality Score es un estimado, <strong class="text-ink">no un diagnóstico médico</strong>.
      <a href="/faq" class="text-accent hover:text-accent-dark ml-1">¿Cómo funciona? →</a>
    </p>
  </div>

</MainLayout>
