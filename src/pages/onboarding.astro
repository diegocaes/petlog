---
import '../styles/global.css';
import { DOG_BREEDS, BREED_FACTS } from '../lib/breeds';

const { supabase, user } = Astro.locals;

// If pet already exists, skip onboarding
const { data: existingPet } = await supabase
  .from('pets')
  .select('id')
  .eq('user_id', user.id)
  .single();

if (existingPet) {
  return Astro.redirect('/dashboard');
}

// Personalized greeting
const fullName = user.user_metadata?.full_name || user.user_metadata?.name || '';
const firstName = fullName.split(' ')[0] || user.email?.split('@')[0] || 'amigo';
const onboardingError = Astro.url.searchParams.get('error');

// Handle final form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();

  const breedSelect = formData.get('breed') as string;
  const breedOther = formData.get('breed_other') as string;
  const breed = breedSelect === 'Other' && breedOther ? breedOther : breedSelect || null;

  const newWeight = formData.get('weight_kg') ? Number(formData.get('weight_kg')) : null;

  const petData = {
    user_id: user.id,
    name: formData.get('name') as string,
    breed,
    birth_date: (formData.get('birth_date') as string) || null,
    gender: (formData.get('gender') as string) || null,
    weight_kg: newWeight,
    chip_id: (formData.get('chip_id') as string) || null,
    color: (formData.get('color') as string) || null,
  };

  // Handle photo upload
  const photoFile = formData.get('photo') as File;
  let photo_url: string | null = null;

  if (photoFile && photoFile.size > 0) {
    const ext = photoFile.name.split('.').pop();
    const filePath = `${user.id}/pet-profile.${ext}`;
    const { error: uploadError } = await supabase.storage
      .from('pet-photos')
      .upload(filePath, photoFile, { upsert: true });

    if (!uploadError) {
      const { data: publicUrl } = supabase.storage
        .from('pet-photos')
        .getPublicUrl(filePath);
      photo_url = publicUrl.publicUrl;
    }
  }

  const { data: newPet, error: insertError } = await supabase
    .from('pets')
    .insert({ ...petData, photo_url })
    .select('id')
    .single();

  if (insertError || !newPet) {
    return Astro.redirect('/onboarding?error=save_failed');
  }

  // Auto-log initial weight
  if (newWeight && newPet.id) {
    await supabase.from('weight_records').insert({
      pet_id: newPet.id,
      weight_kg: newWeight,
      date: new Date().toISOString().split('T')[0],
    });
  }

  return Astro.redirect('/dashboard?onboarded=1');
}

// Serialize breed facts for client-side use (base64 to avoid special char issues)
const breedFactsB64 = Buffer.from(JSON.stringify(BREED_FACTS)).toString('base64');
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#7CB974" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" /></noscript>
    <link rel="icon" href="/icons/icon-192.png" />
    <title>Bienvenido | PetLog</title>
  </head>
  <body class="min-h-screen bg-canvas flex flex-col">

    <!-- Progress bar (hidden on steps 1 & 2) -->
    <div class="fixed top-0 left-0 right-0 z-50" id="progress-bar-wrap" style="display:none">
      <div class="h-2 bg-card-border">
        <div id="progress-fill" class="h-full bg-accent transition-all duration-500 rounded-r-full" style="width:25%"></div>
      </div>
      <div id="progress-text" class="absolute top-4 right-4 text-xs text-muted font-medium">Paso 1 de 4</div>
    </div>

    <!-- Wizard container -->
    <main class="flex-1 flex items-center justify-center p-6 pt-8">
      <div class="w-full max-w-sm mx-auto">

        {onboardingError === 'save_failed' && (
          <div class="mb-4 rounded-xl bg-red-50 border border-red-200 px-4 py-3 text-sm text-red-700">
            Hubo un error al guardar. Intenta de nuevo.
          </div>
        )}

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PASO 1: Bienvenida ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div data-step="1" class="animate-fade-up">
          <div class="relative overflow-hidden rounded-3xl text-white px-6 py-8 shadow-xl" style="background:#1E3B1A">
            <div class="absolute -top-10 -right-10 h-36 w-36 rounded-full bg-white/5"></div>
            <div class="absolute -bottom-8 -left-8 h-28 w-28 rounded-full bg-white/5"></div>

            <div class="relative text-center">
              <div class="text-5xl mb-4 animate-float inline-block">üêæ</div>
              <h1 class="text-2xl font-bold tracking-tight mb-2">
                ¬°Hola, {firstName}!
              </h1>
              <p class="text-sm text-white/70 leading-relaxed mb-6">
                Est√°s a un minuto de tener el pasaporte digital de tu mascota.
              </p>

              <div class="space-y-3 text-left mb-8">
                <div class="flex items-center gap-3 rounded-xl bg-white/10 px-4 py-2.5">
                  <span class="text-lg shrink-0">üêæ</span>
                  <div>
                    <p class="text-sm font-semibold">Perfil y pasaporte</p>
                    <p class="text-xs text-white/60">Pasaporte digital para viajes</p>
                  </div>
                </div>
                <div class="flex items-center gap-3 rounded-xl bg-white/10 px-4 py-2.5">
                  <span class="text-lg shrink-0">üíâ</span>
                  <div>
                    <p class="text-sm font-semibold">Historial de vacunas</p>
                    <p class="text-xs text-white/60">Nunca pierdas un registro</p>
                  </div>
                </div>
                <div class="flex items-center gap-3 rounded-xl bg-white/10 px-4 py-2.5">
                  <span class="text-lg shrink-0">üì∏</span>
                  <div>
                    <p class="text-sm font-semibold">√Ålbum de aventuras</p>
                    <p class="text-xs text-white/60">Guarda los mejores momentos</p>
                  </div>
                </div>
              </div>

              <button
                id="btn-step1-next"
                class="w-full rounded-2xl bg-white text-gray-900 px-6 py-3.5 font-bold text-sm transition-all hover:bg-white/90 active:scale-95 shadow-lg"
              >
                Empezar ‚Üí
              </button>
            </div>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PASO 2: Especie ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div data-step="2" class="hidden">
          <div class="mb-6 text-center">
            <p class="text-xs font-semibold text-accent uppercase tracking-widest mb-1">El primero de muchos</p>
            <h2 class="text-2xl font-bold text-ink">¬øQu√© tipo de mascota tienes?</h2>
            <p class="text-sm text-muted mt-1">Cu√©ntanos un poco sobre tu compa√±ero.</p>
          </div>

          <div class="grid grid-cols-2 gap-4 mb-6">
            <button
              type="button"
              id="species-dog"
              data-species="dog"
              class="species-pill flex flex-col items-center justify-center gap-3 rounded-2xl border-2 border-card-border bg-white px-4 py-8 text-center transition-all hover:border-accent active:scale-95"
            >
              <span class="text-5xl">üêï</span>
              <span class="text-base font-bold text-ink">Perro</span>
            </button>
            <button
              type="button"
              id="species-cat"
              data-species="cat"
              class="species-pill flex flex-col items-center justify-center gap-3 rounded-2xl border-2 border-card-border bg-white px-4 py-8 text-center transition-all hover:border-accent active:scale-95"
            >
              <span class="text-5xl">üê±</span>
              <span class="text-base font-bold text-ink">Gato</span>
            </button>
          </div>

          <p id="species-error" class="text-xs text-red-500 text-center mb-4 hidden">Selecciona una opci√≥n para continuar</p>

          <div class="space-y-3">
            <button
              id="btn-step2-next"
              class="w-full rounded-2xl bg-accent px-6 py-3.5 font-bold text-sm text-white transition-all hover:bg-accent-dark active:scale-95 shadow-md"
            >
              Continuar ‚Üí
            </button>
            <button type="button" id="btn-step2-back" class="w-full text-sm text-muted hover:text-ink transition-colors py-1">
              ‚Üê Atr√°s
            </button>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PASO 3: Nombre, raza y foto ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div data-step="3" class="hidden">
          <div class="mb-6 text-center">
            <p class="text-xs font-semibold text-accent uppercase tracking-widest mb-1">Paso 1 de 4</p>
            <h2 class="text-2xl font-bold text-ink" id="step3-heading">¬øC√≥mo se llama?</h2>
            <p class="text-sm text-muted mt-1">Empieza por lo m√°s importante.</p>
          </div>

          <div class="space-y-5">
            <!-- Photo picker -->
            <div class="flex flex-col items-center gap-2">
              <div class="relative">
                <img
                  id="ob-photo-preview"
                  src="/icons/default-pet.svg"
                  alt="Foto"
                  class="h-24 w-24 rounded-full object-cover border-2 border-card-border shadow-md"
                />
                <label class="absolute -bottom-1 -right-1 flex h-9 w-9 cursor-pointer items-center justify-center rounded-full bg-accent text-white shadow-lg transition-all hover:bg-accent-dark active:scale-95">
                  <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
                  <input type="file" id="ob-photo-input" accept="image/*" class="hidden" />
                </label>
              </div>
              <p class="text-xs text-muted">Foto opcional ‚Äî puedes agregar despu√©s</p>
            </div>

            <!-- Name -->
            <div>
              <label class="block text-sm font-medium text-ink mb-1.5">Nombre <span class="text-red-500">*</span></label>
              <input
                type="text"
                id="ob-name"
                placeholder="Ej: Luna"
                class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-ink placeholder-muted transition-all hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
              />
              <p id="ob-name-error" class="text-xs text-red-500 mt-1 hidden">Por favor ingresa el nombre</p>
            </div>

            <!-- Breed (only for dogs) -->
            <div id="breed-section">
              <label class="block text-sm font-medium text-ink mb-1.5">Raza</label>
              <select
                id="ob-breed-select"
                class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-ink transition-all hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
              >
                <option value="">Seleccionar raza</option>
                {DOG_BREEDS.map((breed) => (
                  <option value={breed}>{breed}</option>
                ))}
              </select>
              <input
                type="text"
                id="ob-breed-other"
                placeholder="Escribe la raza"
                class="hidden mt-2 w-full rounded-xl border border-card-border bg-white px-4 py-3 text-ink placeholder-muted transition-all hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
              />

              <!-- Fun facts card -->
              <div id="breed-facts-card" class="hidden mt-3 rounded-2xl border border-accent/20 bg-accent/5 px-4 py-4">
                <p class="text-xs font-bold text-accent-dark uppercase tracking-wider mb-3">¬øSab√≠as que...?</p>
                <div id="breed-facts-list" class="space-y-2"></div>
              </div>
            </div>
          </div>

          <div class="mt-6 space-y-3">
            <button
              id="btn-step3-next"
              class="w-full rounded-2xl bg-accent px-6 py-3.5 font-bold text-sm text-white transition-all hover:bg-accent-dark active:scale-95 shadow-md"
            >
              Continuar ‚Üí
            </button>
            <button type="button" id="btn-step3-back" class="w-full text-sm text-muted hover:text-ink transition-colors py-1">
              ‚Üê Atr√°s
            </button>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PASO 4: Fecha y g√©nero ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div data-step="4" class="hidden">
          <div class="mb-6 text-center">
            <p class="text-xs font-semibold text-accent uppercase tracking-widest mb-1">Paso 2 de 4</p>
            <h2 class="text-2xl font-bold text-ink">¬øCu√°ndo naci√≥? üéÇ</h2>
            <p class="text-sm text-muted mt-1">Para calcular su edad y recordar su cumplea√±os.</p>
          </div>

          <div class="space-y-5">
            <div>
              <label class="block text-sm font-medium text-ink mb-1.5">Fecha de nacimiento</label>
              <input
                type="date"
                id="ob-birth-date"
                class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-ink transition-all hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
              />
            </div>

            <div>
              <label class="block text-sm font-medium text-ink mb-2">G√©nero</label>
              <div class="grid grid-cols-2 gap-3">
                <button
                  type="button"
                  data-gender="macho"
                  class="gender-pill rounded-2xl border-2 border-card-border bg-white px-4 py-3.5 text-sm font-semibold text-ink transition-all hover:border-accent active:scale-95"
                >
                  Macho ‚ôÇ
                </button>
                <button
                  type="button"
                  data-gender="hembra"
                  class="gender-pill rounded-2xl border-2 border-card-border bg-white px-4 py-3.5 text-sm font-semibold text-ink transition-all hover:border-accent active:scale-95"
                >
                  Hembra ‚ôÄ
                </button>
              </div>
            </div>
          </div>

          <div class="mt-6 space-y-3">
            <button
              id="btn-step4-next"
              class="w-full rounded-2xl bg-accent px-6 py-3.5 font-bold text-sm text-white transition-all hover:bg-accent-dark active:scale-95 shadow-md"
            >
              Continuar ‚Üí
            </button>
            <button type="button" id="btn-step4-skip" class="w-full text-sm text-muted underline hover:text-ink transition-colors py-1">
              Saltar por ahora ‚Üí
            </button>
            <button type="button" id="btn-step4-back" class="w-full text-sm text-muted hover:text-ink transition-colors py-1">
              ‚Üê Atr√°s
            </button>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PASO 5: Datos de salud ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div data-step="5" class="hidden">
          <div class="mb-6 text-center">
            <p class="text-xs font-semibold text-accent uppercase tracking-widest mb-1">Paso 3 de 4</p>
            <h2 class="text-2xl font-bold text-ink">Datos de salud</h2>
            <p class="text-sm text-muted mt-1">Opcional ‚Äî puedes completarlo despu√©s.</p>
          </div>

          <div class="mb-4 flex items-center justify-center">
            <span class="inline-flex items-center gap-1.5 rounded-full border border-amber/30 bg-amber/10 px-3 py-1 text-xs font-medium text-amber-dark">
              <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
              Estos datos son opcionales
            </span>
          </div>

          <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-ink mb-1.5">Peso (kg)</label>
                <input
                  type="number"
                  id="ob-weight"
                  step="0.1"
                  placeholder="Ej: 12.5"
                  class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-ink placeholder-muted transition-all hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-ink mb-1.5">Microchip</label>
                <input
                  type="text"
                  id="ob-chip"
                  placeholder="N¬∫ chip"
                  class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-ink placeholder-muted transition-all hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
                />
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-ink mb-1.5">Color de pelaje</label>
              <input
                type="text"
                id="ob-color"
                placeholder="Ej: Dorado, Negro, Blanco..."
                class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-ink placeholder-muted transition-all hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
              />
            </div>
          </div>

          <div class="mt-6 space-y-3">
            <button
              id="btn-step5-next"
              class="w-full rounded-2xl bg-accent px-6 py-3.5 font-bold text-sm text-white transition-all hover:bg-accent-dark active:scale-95 shadow-md"
            >
              Continuar ‚Üí
            </button>
            <button type="button" id="btn-step5-skip" class="w-full text-sm text-muted underline hover:text-ink transition-colors py-1">
              Saltar y continuar ‚Üí
            </button>
            <button type="button" id="btn-step5-back" class="w-full text-sm text-muted hover:text-ink transition-colors py-1">
              ‚Üê Atr√°s
            </button>
          </div>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ PASO 6: Celebraci√≥n ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div data-step="6" class="hidden">
          <div class="relative overflow-hidden rounded-3xl text-white px-6 py-10 shadow-xl text-center" style="background:#1E3B1A">
            <div class="absolute -top-10 -right-10 h-36 w-36 rounded-full bg-white/5"></div>
            <div class="absolute -bottom-8 -left-8 h-28 w-28 rounded-full bg-white/5"></div>

            <div class="relative">
              <div id="celebration-emoji" class="text-6xl mb-5 animate-float inline-block">üêæ</div>

              <div class="mb-2 inline-flex items-center gap-2 rounded-full bg-white/15 px-4 py-1.5">
                <svg class="h-4 w-4 text-accent" viewBox="0 0 24 24" fill="currentColor"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <span class="text-xs font-semibold text-white">Paso 4 de 4</span>
              </div>

              <h2 class="text-2xl font-bold tracking-tight mt-4 mb-2" id="celebration-title">
                ¬°Listo! El pasaporte est√° creado üéâ
              </h2>
              <p class="text-sm text-white/70 leading-relaxed mb-8">
                Bienvenido a PetLog. Tu mejor amigo ya tiene su historial digital ‚Äî vacunas, peso, aventuras y m√°s.
              </p>

              <button
                id="btn-final-submit"
                class="w-full rounded-2xl bg-white text-gray-900 px-6 py-3.5 font-bold text-sm transition-all hover:bg-white/90 active:scale-95 shadow-lg"
              >
                <span id="btn-final-label">Ver el pasaporte ‚Üí</span>
              </button>
            </div>
          </div>
        </div>

      </div>
    </main>

    <!-- Hidden form ‚Äî populated by JS before final submit -->
    <form id="final-form" method="POST" enctype="multipart/form-data" class="hidden">
      <input type="hidden" name="name" id="ff-name" />
      <input type="hidden" name="breed" id="ff-breed" />
      <input type="hidden" name="breed_other" id="ff-breed-other" />
      <input type="hidden" name="birth_date" id="ff-birth-date" />
      <input type="hidden" name="gender" id="ff-gender" />
      <input type="hidden" name="weight_kg" id="ff-weight" />
      <input type="hidden" name="chip_id" id="ff-chip" />
      <input type="hidden" name="color" id="ff-color" />
    </form>

    <!-- Breed facts data (server ‚Üí client, base64 encoded) -->
    <div id="breed-facts-data" data-facts={breedFactsB64} hidden></div>

    <script>
      // ‚îÄ‚îÄ State ‚îÄ‚îÄ
      let selectedGender = '';
      let selectedSpecies = '';
      let photoFileRef: File | null = null;
      const store: Record<string, string> = {};

      // ‚îÄ‚îÄ Breed facts ‚îÄ‚îÄ
      const factsData: Record<string, Array<{emoji: string; fact: string}>> = (() => {
        try {
          const b64 = document.getElementById('breed-facts-data')?.getAttribute('data-facts') || '';
          const bytes = Uint8Array.from(atob(b64), c => c.charCodeAt(0));
          return JSON.parse(new TextDecoder('utf-8').decode(bytes));
        } catch { return {}; }
      })();

      // ‚îÄ‚îÄ Progress bar ‚îÄ‚îÄ
      function updateProgress(step: number) {
        const wrap = document.getElementById('progress-bar-wrap') as HTMLElement;
        const fill = document.getElementById('progress-fill') as HTMLElement;
        const text = document.getElementById('progress-text') as HTMLElement;

        // Show progress only from step 3 onward (steps 1 & 2 are pre-flow)
        if (step <= 2) {
          wrap.style.display = 'none';
          return;
        }
        wrap.style.display = 'block';

        const stepMap: Record<number, { width: string; label: string }> = {
          3: { width: '25%', label: 'Paso 1 de 4' },
          4: { width: '50%', label: 'Paso 2 de 4' },
          5: { width: '75%', label: 'Paso 3 de 4' },
          6: { width: '100%', label: 'Paso 4 de 4' },
        };
        const info = stepMap[step] || { width: '25%', label: '' };
        fill.style.width = info.width;
        text.textContent = info.label;
      }

      // ‚îÄ‚îÄ Navigate ‚îÄ‚îÄ
      function goTo(step: number) {
        document.querySelectorAll('[data-step]').forEach((el) => {
          (el as HTMLElement).classList.add('hidden');
          (el as HTMLElement).classList.remove('animate-fade-up');
        });
        const target = document.querySelector(`[data-step="${step}"]`) as HTMLElement;
        target.classList.remove('hidden');
        requestAnimationFrame(() => target.classList.add('animate-fade-up'));
        updateProgress(step);
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      // ‚îÄ‚îÄ Step 1 ‚Üí 2 ‚îÄ‚îÄ
      document.getElementById('btn-step1-next')?.addEventListener('click', () => goTo(2));

      // ‚îÄ‚îÄ Species selection ‚îÄ‚îÄ
      document.querySelectorAll('.species-pill').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.species-pill').forEach((b) => {
            b.classList.remove('border-accent', 'bg-accent/10');
            b.classList.add('border-card-border');
          });
          btn.classList.add('border-accent', 'bg-accent/10');
          btn.classList.remove('border-card-border');
          selectedSpecies = (btn as HTMLElement).dataset.species || '';
          document.getElementById('species-error')?.classList.add('hidden');
        });
      });

      document.getElementById('btn-step2-next')?.addEventListener('click', () => {
        if (!selectedSpecies) {
          document.getElementById('species-error')?.classList.remove('hidden');
          return;
        }
        // Update heading and emoji for selected species
        const heading = document.getElementById('step3-heading');
        const celebEmoji = document.getElementById('celebration-emoji');
        if (heading) heading.textContent = selectedSpecies === 'cat' ? '¬øC√≥mo se llama?' : '¬øC√≥mo se llama?';
        if (celebEmoji) celebEmoji.textContent = selectedSpecies === 'cat' ? 'üê±' : 'üêï';
        // Hide breed section for cats (no breed list for cats yet)
        const breedSection = document.getElementById('breed-section');
        if (breedSection) breedSection.style.display = selectedSpecies === 'cat' ? 'none' : 'block';
        goTo(3);
      });
      document.getElementById('btn-step2-back')?.addEventListener('click', () => goTo(1));

      // ‚îÄ‚îÄ Photo preview ‚îÄ‚îÄ
      const photoInput = document.getElementById('ob-photo-input') as HTMLInputElement;
      const photoPreview = document.getElementById('ob-photo-preview') as HTMLImageElement;
      photoInput?.addEventListener('change', () => {
        const file = photoInput.files?.[0];
        if (file) {
          photoFileRef = file;
          const reader = new FileReader();
          reader.onload = (e) => { photoPreview.src = e.target?.result as string; };
          reader.readAsDataURL(file);
        }
      });

      // ‚îÄ‚îÄ Breed select + fun facts ‚îÄ‚îÄ
      const breedSelect = document.getElementById('ob-breed-select') as HTMLSelectElement;
      const breedOtherInput = document.getElementById('ob-breed-other') as HTMLInputElement;
      const factsCard = document.getElementById('breed-facts-card') as HTMLElement;
      const factsList = document.getElementById('breed-facts-list') as HTMLElement;

      breedSelect?.addEventListener('change', () => {
        const val = breedSelect.value;
        // Toggle "Other" input
        breedOtherInput.classList.toggle('hidden', val !== 'Other');
        if (val !== 'Other') breedOtherInput.value = '';

        // Show fun facts
        const facts = factsData[val];
        if (facts && facts.length > 0) {
          factsList.innerHTML = facts.map(f =>
            `<div class="flex items-start gap-2">
              <span class="text-base shrink-0 leading-tight">${f.emoji}</span>
              <p class="text-xs text-ink/80 leading-relaxed">${f.fact}</p>
            </div>`
          ).join('');
          factsCard.classList.remove('hidden');
          factsCard.classList.add('animate-scale-in');
        } else {
          factsCard.classList.add('hidden');
        }
      });

      // ‚îÄ‚îÄ Step 3 ‚Üí 4 ‚îÄ‚îÄ
      document.getElementById('btn-step3-next')?.addEventListener('click', () => {
        const nameInput = document.getElementById('ob-name') as HTMLInputElement;
        const nameError = document.getElementById('ob-name-error') as HTMLElement;

        if (!nameInput.value.trim()) {
          nameInput.classList.add('border-red-400');
          nameError.classList.remove('hidden');
          nameInput.focus();
          return;
        }
        nameInput.classList.remove('border-red-400');
        nameError.classList.add('hidden');

        store.name = nameInput.value.trim();
        store.breed = breedSelect?.value || '';
        store.breedOther = breedOtherInput?.value.trim() || '';

        // Update celebration screen title
        const celebTitle = document.getElementById('celebration-title');
        const celebBtn = document.getElementById('btn-final-label');
        if (celebTitle) celebTitle.textContent = `¬°Listo! El pasaporte de ${store.name} est√° creado üéâ`;
        if (celebBtn) celebBtn.textContent = `Ver el pasaporte de ${store.name} ‚Üí`;

        goTo(4);
      });
      document.getElementById('btn-step3-back')?.addEventListener('click', () => goTo(2));

      // ‚îÄ‚îÄ Gender pills ‚îÄ‚îÄ
      document.querySelectorAll('.gender-pill').forEach((btn) => {
        btn.addEventListener('click', () => {
          document.querySelectorAll('.gender-pill').forEach((b) => {
            b.classList.remove('bg-accent', 'text-white', 'border-accent');
            b.classList.add('border-card-border', 'text-ink', 'bg-white');
          });
          btn.classList.add('bg-accent', 'text-white', 'border-accent');
          btn.classList.remove('border-card-border', 'text-ink', 'bg-white');
          selectedGender = (btn as HTMLElement).dataset.gender || '';
        });
      });

      // ‚îÄ‚îÄ Step 4 ‚Üí 5 ‚îÄ‚îÄ
      document.getElementById('btn-step4-next')?.addEventListener('click', () => {
        store.birthDate = (document.getElementById('ob-birth-date') as HTMLInputElement).value;
        store.gender = selectedGender;
        goTo(5);
      });
      document.getElementById('btn-step4-skip')?.addEventListener('click', () => {
        store.birthDate = '';
        store.gender = '';
        goTo(5);
      });
      document.getElementById('btn-step4-back')?.addEventListener('click', () => goTo(3));

      // ‚îÄ‚îÄ Step 5 ‚Üí 6 ‚îÄ‚îÄ
      function goToStep5Next(skipOptional: boolean) {
        if (!skipOptional) {
          store.weight = (document.getElementById('ob-weight') as HTMLInputElement).value;
          store.chip = (document.getElementById('ob-chip') as HTMLInputElement).value;
          store.color = (document.getElementById('ob-color') as HTMLInputElement).value;
        } else {
          store.weight = '';
          store.chip = '';
          store.color = '';
        }
        goTo(6);
      }
      document.getElementById('btn-step5-next')?.addEventListener('click', () => goToStep5Next(false));
      document.getElementById('btn-step5-skip')?.addEventListener('click', () => goToStep5Next(true));
      document.getElementById('btn-step5-back')?.addEventListener('click', () => goTo(4));

      // ‚îÄ‚îÄ Final submit (from celebration screen) ‚îÄ‚îÄ
      function submitFinal() {
        (document.getElementById('ff-name') as HTMLInputElement).value = store.name || '';
        (document.getElementById('ff-breed') as HTMLInputElement).value = store.breed || '';
        (document.getElementById('ff-breed-other') as HTMLInputElement).value = store.breedOther || '';
        (document.getElementById('ff-birth-date') as HTMLInputElement).value = store.birthDate || '';
        (document.getElementById('ff-gender') as HTMLInputElement).value = store.gender || '';
        (document.getElementById('ff-weight') as HTMLInputElement).value = store.weight || '';
        (document.getElementById('ff-chip') as HTMLInputElement).value = store.chip || '';
        (document.getElementById('ff-color') as HTMLInputElement).value = store.color || '';

        // Inject photo file via DataTransfer
        if (photoFileRef) {
          const dt = new DataTransfer();
          dt.items.add(photoFileRef);
          let photoHidden = document.querySelector<HTMLInputElement>('#final-form input[name="photo"]');
          if (!photoHidden) {
            photoHidden = document.createElement('input');
            photoHidden.type = 'file';
            photoHidden.name = 'photo';
            document.getElementById('final-form')?.appendChild(photoHidden);
          }
          photoHidden.files = dt.files;
        }

        const btn = document.getElementById('btn-final-submit') as HTMLButtonElement;
        btn.classList.add('btn-loading');
        btn.setAttribute('disabled', '');

        (document.getElementById('final-form') as HTMLFormElement).submit();
      }

      document.getElementById('btn-final-submit')?.addEventListener('click', submitFinal);
    </script>
  </body>
</html>
