---
import MainLayout from '../layouts/MainLayout.astro';
import Card from '../components/ui/Card.astro';
import Input from '../components/ui/Input.astro';
import Button from '../components/ui/Button.astro';
import SectionHeader from '../components/ui/SectionHeader.astro';
import { DOG_BREEDS } from '../lib/breeds';
import { createSupabaseAdminClient } from '../lib/supabase';

const { supabase, user } = Astro.locals;
const isNew = Astro.url.searchParams.get('new') === '1';

// Extract first name for personalized greeting
const fullName = user.user_metadata?.full_name || user.user_metadata?.name || '';
const firstName = fullName.split(' ')[0] || user.email?.split('@')[0] || 'bienvenido';

// Get existing pet
const { data: pet } = await supabase
  .from('pets')
  .select('*')
  .eq('user_id', user.id)
  .single();

// Profile completion badge logic
const profileFields = pet ? [
  !!pet.name,
  !!pet.breed,
  !!pet.birth_date,
  !!pet.gender,
  !!pet.photo_url,
  !!pet.weight_kg,
  !!pet.chip_id,
  !!(pet as any).color,
] : [];
const completedFields = profileFields.filter(Boolean).length;
const totalFields = profileFields.length;
const isProfileComplete = pet && completedFields === totalFields;
const completionPct = pet ? Math.round((completedFields / totalFields) * 100) : 0;

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('_action') as string;

  if (action === 'logout') {
    await supabase.auth.signOut();
    return Astro.redirect('/login');
  }

  if (action === 'delete_account') {
    // Delete pet (cascades to all related tables via FK)
    if (pet) {
      await supabase.from('pets').delete().eq('id', pet.id);
    }
    // Delete auth user via admin client
    try {
      const adminClient = createSupabaseAdminClient();
      await adminClient.auth.admin.deleteUser(user.id);
    } catch (_e) {
      // If admin client unavailable, just sign out ‚Äî data is already deleted
    }
    await supabase.auth.signOut();
    return Astro.redirect('/');
  }

  // Resolve breed: if "Otro" is selected, use the text input
  const breedSelect = formData.get('breed') as string;
  const breedOther = formData.get('breed_other') as string;
  const breed = breedSelect === 'Otro' && breedOther ? breedOther : breedSelect || null;

  const newWeight = formData.get('weight_kg') ? Number(formData.get('weight_kg')) : null;

  const petData = {
    user_id: user.id,
    name: formData.get('name') as string,
    breed,
    birth_date: (formData.get('birth_date') as string) || null,
    gender: (formData.get('gender') as string) || null,
    weight_kg: newWeight,
    chip_id: (formData.get('chip_id') as string) || null,
    color: (formData.get('color') as string) || null,
  };

  // Handle photo upload
  const photoFile = formData.get('photo') as File;
  let photo_url = pet?.photo_url || null;

  if (photoFile && photoFile.size > 0) {
    const ext = photoFile.name.split('.').pop();
    const filePath = `${user.id}/pet-profile.${ext}`;
    const { error: uploadError } = await supabase.storage
      .from('pet-photos')
      .upload(filePath, photoFile, { upsert: true });

    if (!uploadError) {
      const { data: publicUrl } = supabase.storage
        .from('pet-photos')
        .getPublicUrl(filePath);
      photo_url = publicUrl.publicUrl;
    }
  }

  let petId = pet?.id;

  if (pet) {
    await supabase.from('pets').update({ ...petData, photo_url }).eq('id', pet.id);
  } else {
    const { data: newPet } = await supabase.from('pets').insert({ ...petData, photo_url }).select('id').single();
    petId = newPet?.id;
  }

  // Auto-log weight record if weight changed
  if (newWeight && petId) {
    const weightChanged = !pet || pet.weight_kg !== newWeight;
    if (weightChanged) {
      await supabase.from('weight_records').insert({
        pet_id: petId,
        weight_kg: newWeight,
        date: new Date().toISOString().split('T')[0],
      });
    }
  }

  return Astro.redirect('/dashboard?saved=1');
}

// Check if current breed is in the list (for "Otro" logic)
const breedInList = pet?.breed ? DOG_BREEDS.includes(pet.breed as typeof DOG_BREEDS[number]) : false;
const isOtherBreed = pet?.breed && !breedInList;
---

<MainLayout title={isNew ? 'Registra a tu mascota' : 'Perfil'}>
  {isNew ? (
    <div class="mb-6 animate-fade-up">
      <!-- Hero welcome card -->
      <div class="relative overflow-hidden rounded-3xl bg-[#1E3B1A] px-6 py-8 text-center text-white shadow-xl mb-4">
        <!-- Decorative circles -->
        <div class="absolute -top-8 -right-8 h-32 w-32 rounded-full bg-white/5"></div>
        <div class="absolute -bottom-6 -left-6 h-24 w-24 rounded-full bg-white/5"></div>

        <div class="relative">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-2xl bg-white/10 text-3xl shadow-inner">
            üêæ
          </div>
          <p class="text-2xl font-bold tracking-tight">
            ¬°Hola, {firstName}!
          </p>
          <p class="mt-2 text-sm text-white/70 leading-relaxed max-w-xs mx-auto">
            Vamos a registrar a tu mascota. Solo toma un minuto y tendr√°s su pasaporte digital listo.
          </p>
        </div>

        <!-- Steps -->
        <div class="relative mt-6 flex items-center justify-center gap-2 text-xs text-white/60">
          <span class="flex h-5 w-5 items-center justify-center rounded-full bg-accent text-white font-bold text-xs">1</span>
          <span>Datos</span>
          <span class="h-px w-4 bg-white/20"></span>
          <span class="flex h-5 w-5 items-center justify-center rounded-full bg-white/20 font-bold text-xs">2</span>
          <span>Foto</span>
          <span class="h-px w-4 bg-white/20"></span>
          <span class="flex h-5 w-5 items-center justify-center rounded-full bg-white/20 font-bold text-xs">3</span>
          <span>Vacunas</span>
        </div>
      </div>
    </div>
  ) : (
    <SectionHeader title="Perfil" subtitle="Datos de tu mascota" />
  )}

  <Card variant="elevated" class="animate-fade-up animate-fade-up-delay-1">
    <form method="POST" enctype="multipart/form-data" class="space-y-6">
      <!-- Photo -->
      <div class="flex flex-col items-center gap-3">
        <div class="relative">
          <img
            id="photo-preview"
            src={pet?.photo_url || '/icons/default-pet.svg'}
            alt="Foto de mascota"
            class="h-28 w-28 rounded-3xl object-cover border-2 border-card-border shadow-md"
          />
          <label class="absolute -bottom-2 -right-2 flex h-10 w-10 cursor-pointer items-center justify-center rounded-full bg-accent text-white shadow-lg transition-all hover:bg-accent-dark active:scale-95">
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
            <input type="file" name="photo" accept="image/*" class="hidden" id="photo-input" />
          </label>
        </div>
        <p class="text-xs text-gray-400">Toca para cambiar la foto</p>
      </div>

      <!-- Section: Datos B√°sicos -->
      <div class="space-y-4">
        <div class="flex items-center gap-2 text-xs font-semibold text-muted uppercase tracking-widest">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/></svg>
          Datos B√°sicos
        </div>

        <Input label="Nombre" name="name" value={pet?.name || ''} required placeholder="Ej: Luna" />

        <!-- Breed Dropdown -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1.5">Raza</label>
          <select
            name="breed"
            id="breed-select"
            class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-gray-800 transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
          >
            <option value="">Seleccionar raza</option>
            {DOG_BREEDS.map((breed) => (
              <option value={breed} selected={pet?.breed === breed || (isOtherBreed && breed === 'Otro')}>
                {breed}
              </option>
            ))}
          </select>
          <input
            type="text"
            name="breed_other"
            id="breed-other-input"
            placeholder="Escribe la raza"
            value={isOtherBreed ? pet?.breed : ''}
            class:list={[
              'mt-2 w-full rounded-xl border border-card-border bg-white px-4 py-3 text-gray-800 placeholder-gray-400 transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20',
              { hidden: !isOtherBreed },
            ]}
          />
        </div>

        <div class="grid grid-cols-2 gap-4">
          <Input label="Fecha de nacimiento" name="birth_date" type="date" value={pet?.birth_date || ''} />
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">G√©nero</label>
            <select
              name="gender"
              class="w-full rounded-xl border border-card-border bg-white px-4 py-3 text-gray-800 transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
            >
              <option value="">Seleccionar</option>
              <option value="macho" selected={pet?.gender === 'macho'}>Macho ‚ôÇÔ∏è</option>
              <option value="hembra" selected={pet?.gender === 'hembra'}>Hembra ‚ôÄÔ∏è</option>
            </select>
          </div>
        </div>
      </div>

      <hr class="border-card-border/50" />

      <!-- Section: Datos M√©dicos -->
      <div class="space-y-4">
        <div class="flex items-center gap-2 text-xs font-semibold text-muted uppercase tracking-widest">
          <svg class="h-3.5 w-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19.5 12.572l-7.5 7.428l-7.5 -7.428a5 5 0 1 1 7.5 -6.566a5 5 0 1 1 7.5 6.572"/></svg>
          Datos M√©dicos
        </div>

        <div class="grid grid-cols-2 gap-4">
          <Input label="Peso (kg)" name="weight_kg" type="number" step="0.1" value={pet?.weight_kg?.toString() || ''} placeholder="Ej: 12.5" />
          <Input label="N¬∫ Microchip" name="chip_id" value={pet?.chip_id || ''} placeholder="Ej: 123456789" />
        </div>
        <p class="text-xs text-gray-400 -mt-2">Al cambiar el peso se guarda autom√°ticamente en el historial</p>
        <Input label="Color de pelaje" name="color" value={(pet as any)?.color || ''} placeholder="Ej: Dorado, Negro, Blanco..." />
      </div>

      <Button type="submit" variant="primary" size="lg" class="w-full">
        {pet ? 'Guardar cambios' : 'Crear perfil'}
      </Button>
    </form>
  </Card>

  <!-- Profile completion badge -->
  {pet && (
    <div class="mt-4 animate-fade-up animate-fade-up-delay-2">
      {isProfileComplete ? (
        <div class="rounded-2xl border border-accent/30 bg-accent/5 px-5 py-4 flex items-center gap-4">
          <img src="/badges/perfil-completo.png" alt="Perfil completo" class="h-16 w-16 object-contain shrink-0" />
          <div>
            <p class="text-sm font-bold text-accent-dark">¬°Perfil completo! üéâ</p>
            <p class="text-xs text-muted mt-0.5">Ganaste el badge de registro exitoso. El pasaporte de {pet.name} tiene toda la informaci√≥n.</p>
          </div>
        </div>
      ) : (
        <div class="rounded-2xl border border-card-border bg-white px-5 py-4">
          <div class="flex items-center gap-4 mb-3">
            <div class="relative h-14 w-14 shrink-0">
              <img src="/badges/perfil-completo.png" alt="Badge bloqueado" class="h-14 w-14 object-contain opacity-25 grayscale" />
              <div class="absolute inset-0 flex items-center justify-center">
                <svg class="h-5 w-5 text-muted" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              </div>
            </div>
            <div class="flex-1">
              <p class="text-sm font-bold text-ink">Badge: Perfil completo</p>
              <p class="text-xs text-muted mt-0.5">{completedFields} de {totalFields} campos completados</p>
              <!-- Progress bar -->
              <div class="mt-2 h-1.5 w-full rounded-full bg-card-border overflow-hidden">
                <div class="h-full bg-accent rounded-full transition-all duration-500" style={`width:${completionPct}%`}></div>
              </div>
            </div>
          </div>
          <p class="text-xs text-muted">Completa todos los datos del perfil para desbloquear este badge.</p>
        </div>
      )}
    </div>
  )}

  <!-- Logout & Account Info -->
  <Card variant="elevated" class="mt-4 animate-fade-up animate-fade-up-delay-2">
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-ink">Cuenta</p>
        <p class="text-xs text-gray-400 truncate max-w-50">{user.email}</p>
      </div>
      <form method="POST">
        <input type="hidden" name="_action" value="logout" />
        <Button type="submit" variant="danger" size="sm">
          Cerrar sesi√≥n
        </Button>
      </form>
    </div>

    <hr class="border-card-border/50 my-4" />

    <!-- Delete account -->
    <div class="flex items-center justify-between">
      <div>
        <p class="text-sm font-medium text-red-500">Eliminar cuenta</p>
        <p class="text-xs text-gray-400 mt-0.5">Borra todos tus datos permanentemente</p>
      </div>
      <button
        type="button"
        id="btn-delete-account"
        class="rounded-xl border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-semibold text-red-500 transition-all hover:bg-red-100 active:scale-95"
      >
        Eliminar
      </button>
    </div>
  </Card>

  <!-- Delete account confirmation modal -->
  <div id="delete-modal" class="fixed inset-0 z-50 items-end justify-center p-4 bg-black/40 backdrop-blur-sm hidden">
    <div class="w-full max-w-sm rounded-3xl bg-white p-6 shadow-2xl animate-scale-in">
      <div class="mb-4 flex h-14 w-14 items-center justify-center rounded-2xl bg-red-50 mx-auto text-2xl">
        ‚ö†Ô∏è
      </div>
      <h3 class="text-center text-base font-bold text-ink mb-2">¬øEliminar cuenta?</h3>
      <p class="text-center text-sm text-muted mb-6 leading-relaxed">
        Se borrar√°n tu perfil, el de tu mascota, vacunas, aventuras y todos tus datos. <strong class="text-ink">Esta acci√≥n no se puede deshacer.</strong>
      </p>
      <form method="POST" id="delete-account-form">
        <input type="hidden" name="_action" value="delete_account" />
        <button
          type="submit"
          id="btn-confirm-delete"
          class="w-full rounded-xl bg-red-500 px-6 py-3 text-sm font-semibold text-white transition-all hover:bg-red-600 active:scale-95 mb-3"
        >
          S√≠, eliminar todo
        </button>
      </form>
      <button
        type="button"
        id="btn-cancel-delete"
        class="w-full rounded-xl border border-card-border px-6 py-3 text-sm font-semibold text-muted transition-all hover:bg-canvas active:scale-95"
      >
        Cancelar
      </button>
    </div>
  </div>

  <script>
    // Photo preview
    const input = document.getElementById('photo-input') as HTMLInputElement;
    const preview = document.getElementById('photo-preview') as HTMLImageElement;
    input?.addEventListener('change', () => {
      const file = input.files?.[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => { preview.src = e.target?.result as string; };
        reader.readAsDataURL(file);
      }
    });

    // Breed "Otro" toggle
    const select = document.getElementById('breed-select') as HTMLSelectElement;
    const otherInput = document.getElementById('breed-other-input') as HTMLInputElement;
    function toggleOther() {
      otherInput.classList.toggle('hidden', select.value !== 'Otro');
      if (select.value !== 'Otro') otherInput.value = '';
    }
    select?.addEventListener('change', toggleOther);

    // Delete account modal
    const modal = document.getElementById('delete-modal') as HTMLDivElement;
    const btnOpen = document.getElementById('btn-delete-account') as HTMLButtonElement;
    const btnCancel = document.getElementById('btn-cancel-delete') as HTMLButtonElement;
    const btnConfirm = document.getElementById('btn-confirm-delete') as HTMLButtonElement;

    btnOpen?.addEventListener('click', () => {
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    });
    btnCancel?.addEventListener('click', () => {
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    });
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });
    document.getElementById('delete-account-form')?.addEventListener('submit', () => {
      btnConfirm.textContent = 'Eliminando...';
      btnConfirm.setAttribute('disabled', '');
    });
  </script>
</MainLayout>
