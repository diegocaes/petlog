---
import '../styles/global.css';
import { createSupabaseClient } from '../lib/supabase';

const supabase = createSupabaseClient(Astro.request, Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (user) {
  return Astro.redirect('/dashboard');
}

const error = Astro.url.searchParams.get('error');
const success = Astro.url.searchParams.get('success');

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action') as string;
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;

  if (action === 'google') {
    const origin = new URL(Astro.request.url).origin;
    const { data, error: oauthError } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: `${origin}/api/auth/callback` },
    });
    if (oauthError || !data.url) {
      return Astro.redirect('/register?error=auth_failed');
    }
    return Astro.redirect(data.url);
  }

  if (action === 'register') {
    const { error: registerError } = await supabase.auth.signUp({ email, password });
    if (registerError) {
      return Astro.redirect('/register?error=register_failed');
    }
    return Astro.redirect('/register?success=check_email');
  }
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#7CB974" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/icons/icon-192.png" />
    <title>Crear cuenta | PetLog</title>
  </head>
  <body class="flex min-h-screen bg-canvas">

    <!-- Left panel (desktop only) -->
    <div class="hidden lg:flex lg:flex-col lg:w-105 lg:shrink-0 bg-sidebar text-white p-10 relative overflow-hidden">
      <div class="absolute inset-0 opacity-10">
        <div class="absolute top-20 -left-20 h-64 w-64 rounded-full bg-accent blur-3xl"></div>
        <div class="absolute bottom-20 right-10 h-48 w-48 rounded-full bg-amber blur-3xl"></div>
      </div>
      <div class="relative">
        <div class="flex items-center gap-3 mb-12">
          <span class="text-3xl">ğŸ¾</span>
          <span class="text-xl font-bold tracking-tight">PetLog</span>
        </div>
        <h2 class="text-3xl font-bold leading-tight mb-4">Empieza el diario<br/>digital de tu mascota</h2>
        <p class="text-white/60 text-sm leading-relaxed mb-8">Todo lo que necesitas para cuidar a tu mejor amigo, en un solo lugar.</p>

        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-accent/20 text-base">ğŸ¾</div>
            <div>
              <p class="text-sm font-semibold">Perfil y pasaporte</p>
              <p class="text-xs text-white/50">Pasaporte digital para viajes</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-accent/20 text-base">ğŸ’‰</div>
            <div>
              <p class="text-sm font-semibold">Historial de vacunas</p>
              <p class="text-xs text-white/50">Nunca pierdas un registro</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-accent/20 text-base">ğŸ“¸</div>
            <div>
              <p class="text-sm font-semibold">Ãlbum de aventuras</p>
              <p class="text-xs text-white/50">Guarda los mejores momentos</p>
            </div>
          </div>
        </div>
      </div>
      <div class="relative mt-auto">
        <p class="text-xs text-white/30">Gratis Â· Sin tarjeta de crÃ©dito</p>
      </div>
    </div>

    <!-- Right panel -->
    <div class="flex flex-1 items-center justify-center p-6">
      <div class="w-full max-w-sm">

        <!-- Mobile logo -->
        <div class="mb-8 text-center lg:hidden animate-fade-up">
          <div class="mx-auto mb-3 flex h-16 w-16 items-center justify-center rounded-2xl bg-sidebar text-3xl">
            ğŸ¾
          </div>
          <h1 class="text-2xl font-bold text-ink">PetLog</h1>
          <p class="text-sm text-muted mt-1">El diario digital de tu mascota</p>
        </div>

        {success === 'check_email' ? (
          <!-- Email sent confirmation screen -->
          <div class="animate-scale-in text-center">
            <div class="mx-auto mb-5 flex h-20 w-20 items-center justify-center rounded-3xl bg-accent/10 text-4xl">
              ğŸ“¬
            </div>
            <h2 class="text-2xl font-bold text-ink mb-2">Revisa tu correo</h2>
            <p class="text-sm text-muted leading-relaxed mb-6">
              Te enviamos un enlace de confirmaciÃ³n. Haz clic en Ã©l para activar tu cuenta y empezar a usar PetLog.
            </p>
            <div class="rounded-2xl border border-card-border bg-white px-4 py-4 text-left mb-6">
              <p class="text-xs text-muted font-medium mb-1">Â¿No llegÃ³ el correo?</p>
              <p class="text-xs text-muted">Revisa tu carpeta de spam o espera unos minutos.</p>
            </div>
            <a href="/login" class="block text-sm text-accent font-semibold hover:text-accent-dark">
              â† Volver al inicio
            </a>
          </div>
        ) : (
          <div class="animate-fade-up lg:animate-none">
            <h2 class="text-xl font-bold text-ink mb-1">Crea tu cuenta</h2>
            <p class="text-sm text-muted mb-6">Solo toma 30 segundos</p>

            {error && (
              <div class="mb-4 rounded-xl bg-red-50 border border-red-200 px-4 py-3 text-sm text-red-700">
                {error === 'register_failed' && 'No se pudo crear la cuenta. Intenta con otro email.'}
                {error === 'auth_failed' && 'Error al conectar con Google. Intenta de nuevo.'}
              </div>
            )}

            <!-- Google OAuth -->
            <form method="POST">
              <button
                type="submit"
                name="action"
                value="google"
                class="flex w-full items-center justify-center gap-3 rounded-xl border border-card-border bg-white px-4 py-2.5 text-sm font-semibold text-ink shadow-sm transition-all duration-200 hover:bg-gray-50 hover:border-gray-300 active:scale-95"
              >
                <svg width="18" height="18" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M47.532 24.552c0-1.636-.147-3.2-.42-4.698H24.48v8.886h12.988c-.56 3.016-2.26 5.572-4.816 7.284v6.05h7.796c4.56-4.198 7.084-10.38 7.084-17.522z" fill="#4285F4"/>
                  <path d="M24.48 48c6.516 0 11.98-2.16 15.972-5.86l-7.796-6.05c-2.16 1.448-4.924 2.304-8.176 2.304-6.288 0-11.612-4.246-13.516-9.952H2.9v6.246C6.876 42.852 15.068 48 24.48 48z" fill="#34A853"/>
                  <path d="M10.964 28.442A14.46 14.46 0 0 1 10.2 24c0-1.54.264-3.036.764-4.442v-6.246H2.9A23.964 23.964 0 0 0 .48 24c0 3.87.928 7.532 2.42 10.688l8.064-6.246z" fill="#FBBC05"/>
                  <path d="M24.48 9.558c3.54 0 6.716 1.216 9.216 3.604l6.908-6.908C36.456 2.392 30.996 0 24.48 0 15.068 0 6.876 5.148 2.9 13.312l8.064 6.246c1.904-5.706 7.228-9.952 13.516-9.952z" fill="#EA4335"/>
                </svg>
                Continuar con Google
              </button>
            </form>

            <div class="flex items-center gap-3 my-4">
              <div class="flex-1 h-px bg-card-border"></div>
              <span class="text-xs text-muted font-medium">o con email</span>
              <div class="flex-1 h-px bg-card-border"></div>
            </div>

            <!-- Register form -->
            <form method="POST" class="space-y-4" id="register-form">
              <input type="hidden" name="action" value="register" />
              <div>
                <label class="block text-sm font-medium text-ink mb-1.5">Email</label>
                <input
                  type="email"
                  name="email"
                  required
                  placeholder="tu@email.com"
                  class="w-full rounded-xl border border-card-border bg-white px-4 py-2.5 text-ink placeholder-muted text-sm transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-ink mb-1.5">ContraseÃ±a</label>
                <input
                  type="password"
                  name="password"
                  required
                  minlength="6"
                  placeholder="MÃ­nimo 6 caracteres"
                  class="w-full rounded-xl border border-card-border bg-white px-4 py-2.5 text-ink placeholder-muted text-sm transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
                />
              </div>

              <button
                type="submit"
                id="btn-register"
                class="w-full rounded-xl bg-accent px-6 py-3 text-sm font-semibold text-white transition-all duration-200 hover:bg-accent-dark active:scale-95"
              >
                Crear cuenta
              </button>
            </form>

            <p class="mt-5 text-center text-sm text-muted">
              Â¿Ya tienes cuenta?
              <a href="/login" class="font-semibold text-accent hover:text-accent-dark ml-1">Entrar â†’</a>
            </p>
          </div>
        )}
      </div>
    </div>

    <script>
      const form = document.getElementById('register-form') as HTMLFormElement;
      form?.addEventListener('submit', () => {
        const btn = document.getElementById('btn-register') as HTMLButtonElement;
        if (btn) {
          btn.classList.add('btn-loading');
          btn.setAttribute('disabled', '');
        }
      });
    </script>
  </body>
</html>
