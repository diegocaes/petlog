---
import '../styles/global.css';
import { createSupabaseClient } from '../lib/supabase';

const supabase = createSupabaseClient(Astro.request, Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (user) {
  return Astro.redirect('/dashboard');
}

const error = Astro.url.searchParams.get('error');
const success = Astro.url.searchParams.get('success');

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const action = formData.get('action') as string;
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;

  if (action === 'google') {
    const origin = new URL(Astro.request.url).origin;
    const { data, error: oauthError } = await supabase.auth.signInWithOAuth({
      provider: 'google',
      options: { redirectTo: `${origin}/api/auth/callback` },
    });
    if (oauthError || !data.url) {
      return Astro.redirect('/register?error=auth_failed');
    }
    return Astro.redirect(data.url);
  }

  if (action === 'register') {
    const cleanEmail = email?.trim().toLowerCase();
    const cleanPassword = password?.trim();
    const confirmPassword = (formData.get('confirm_password') as string)?.trim();

    if (!cleanPassword || cleanPassword.length < 8) {
      return Astro.redirect('/register?error=weak_password');
    }
    if (cleanPassword !== confirmPassword) {
      return Astro.redirect('/register?error=password_mismatch');
    }

    const { data: signUpData, error: registerError } = await supabase.auth.signUp({
      email: cleanEmail,
      password: cleanPassword,
    });
    if (registerError) {
      const msg = registerError.message?.toLowerCase() ?? '';
      const code = msg.includes('already registered') || msg.includes('already exists') || msg.includes('user already')
        ? 'email_exists'
        : 'register_failed';
      return Astro.redirect(`/register?error=${code}`);
    }
    if (!signUpData.user) {
      return Astro.redirect('/register?error=register_failed');
    }
    return Astro.redirect('/register?success=check_email');
  }
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#F97316" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" as="style" onload="this.onload=null;this.rel='stylesheet'" />
    <noscript><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" /></noscript>
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/icons/icon-192.png" />
    <title>Crear cuenta | PetLog</title>
    <style>
      .right-panel {
        position: relative;
      }
      .right-panel::before {
        content: '';
        position: absolute; inset: 0;
        background-image: url('/PetLog.png');
        background-size: 380px auto;
        background-repeat: repeat;
        opacity: 0.10;
        pointer-events: none;
        mix-blend-mode: multiply;
      }
    </style>
  </head>
  <body class="flex min-h-screen bg-canvas">

    <!-- Left panel (desktop only) -->
    <div class="hidden lg:flex lg:flex-col lg:w-105 lg:shrink-0 bg-sidebar text-white p-10 relative overflow-hidden">
      <div class="absolute inset-0 opacity-10">
        <div class="absolute top-20 -left-20 h-64 w-64 rounded-full bg-accent blur-3xl"></div>
        <div class="absolute bottom-20 right-10 h-48 w-48 rounded-full bg-amber blur-3xl"></div>
      </div>
      <div class="relative">
        <a href="/" class="flex items-center mb-12 hover:opacity-80 transition-opacity">
          <img src="/PetLog-logo.svg" alt="PetLog" style="height:80px;width:auto;filter:brightness(0) invert(1);" />
        </a>
        <h2 class="text-3xl font-bold leading-tight mb-4">Empieza el diario<br/>digital de tu mascota</h2>
        <p class="text-white/60 text-sm leading-relaxed mb-8">Todo lo que necesitas para cuidar a tu mejor amigo, en un solo lugar.</p>

        <div class="space-y-4">
          <div class="flex items-center gap-3">
            <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-orange-500/20 text-base">üêæ</div>
            <div>
              <p class="text-sm font-semibold">Perfil y pasaporte</p>
              <p class="text-xs text-white/50">Pasaporte digital para viajes</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-orange-500/20 text-base">üíâ</div>
            <div>
              <p class="text-sm font-semibold">Historial de vacunas</p>
              <p class="text-xs text-white/50">Nunca pierdas un registro</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-orange-500/20 text-base">üì∏</div>
            <div>
              <p class="text-sm font-semibold">√Ålbum de aventuras</p>
              <p class="text-xs text-white/50">Guarda los mejores momentos</p>
            </div>
          </div>
        </div>
      </div>
      <div class="relative mt-auto">
        <p class="text-xs text-white/30">Gratis ¬∑ Sin tarjeta de cr√©dito</p>
      </div>
    </div>

    <!-- Right panel -->
    <div class="right-panel flex flex-1 items-center justify-center p-6">
      <div class="w-full max-w-sm">

        <!-- Mobile logo -->
        <div class="mb-8 text-center lg:hidden animate-fade-up">
          <a href="/" class="inline-flex items-center hover:opacity-80 transition-opacity">
            <img src="/PetLog-logo.svg" alt="PetLog" style="height:72px;width:auto;" />
          </a>
          <p class="text-sm text-muted mt-1">El diario digital de tu mascota</p>
        </div>

        {success === 'check_email' ? (
          <!-- Email sent confirmation screen -->
          <div class="animate-scale-in text-center">
            <div class="mx-auto mb-5 flex h-20 w-20 items-center justify-center rounded-3xl bg-accent/10 text-4xl">
              üì¨
            </div>
            <h2 class="text-2xl font-bold text-ink mb-2">Revisa tu correo</h2>
            <p class="text-sm text-muted leading-relaxed mb-6">
              Te enviamos un enlace de confirmaci√≥n. Haz clic en √©l para activar tu cuenta y empezar a usar PetLog.
            </p>
            <div class="rounded-2xl border border-card-border bg-white px-4 py-4 text-left mb-6">
              <p class="text-xs text-muted font-medium mb-1">¬øNo lleg√≥ el correo?</p>
              <p class="text-xs text-muted">Revisa tu carpeta de spam o espera unos minutos.</p>
            </div>
            <a href="/login" class="block text-sm text-accent font-semibold hover:text-accent-dark">
              ‚Üê Volver al inicio
            </a>
          </div>
        ) : (
          <div class="animate-fade-up lg:animate-none">
            <h2 class="text-xl font-bold text-ink mb-1">Crea tu cuenta</h2>
            <p class="text-sm text-muted mb-6">Solo toma 30 segundos</p>

            {error && (
              <div class="mb-4 rounded-xl bg-red-50 border border-red-200 px-4 py-3 text-sm text-red-700">
                {error === 'register_failed' && 'No se pudo crear la cuenta. Intenta de nuevo.'}
                {error === 'email_exists' && (
                  <span>Este email ya tiene una cuenta. <a href="/login" class="font-semibold underline">Inicia sesi√≥n ‚Üí</a></span>
                )}
                {error === 'auth_failed' && 'Error al conectar con Google. Intenta de nuevo.'}
                {error === 'weak_password' && 'La contrase√±a debe tener al menos 8 caracteres.'}
                {error === 'password_mismatch' && 'Las contrase√±as no coinciden.'}
              </div>
            )}

            <!-- Google OAuth -->
            <form method="POST" id="google-form-reg">
              <button
                type="submit"
                name="action"
                value="google"
                id="btn-google-reg"
                class="flex w-full items-center justify-center gap-3 rounded-xl border border-card-border bg-white px-4 py-2.5 text-sm font-semibold text-ink shadow-sm transition-all duration-200 hover:bg-gray-50 hover:border-gray-300 active:scale-95"
              >
                <svg width="18" height="18" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M47.532 24.552c0-1.636-.147-3.2-.42-4.698H24.48v8.886h12.988c-.56 3.016-2.26 5.572-4.816 7.284v6.05h7.796c4.56-4.198 7.084-10.38 7.084-17.522z" fill="#4285F4"/>
                  <path d="M24.48 48c6.516 0 11.98-2.16 15.972-5.86l-7.796-6.05c-2.16 1.448-4.924 2.304-8.176 2.304-6.288 0-11.612-4.246-13.516-9.952H2.9v6.246C6.876 42.852 15.068 48 24.48 48z" fill="#34A853"/>
                  <path d="M10.964 28.442A14.46 14.46 0 0 1 10.2 24c0-1.54.264-3.036.764-4.442v-6.246H2.9A23.964 23.964 0 0 0 .48 24c0 3.87.928 7.532 2.42 10.688l8.064-6.246z" fill="#FBBC05"/>
                  <path d="M24.48 9.558c3.54 0 6.716 1.216 9.216 3.604l6.908-6.908C36.456 2.392 30.996 0 24.48 0 15.068 0 6.876 5.148 2.9 13.312l8.064 6.246c1.904-5.706 7.228-9.952 13.516-9.952z" fill="#EA4335"/>
                </svg>
                Continuar con Google
              </button>
            </form>

            <div class="flex items-center gap-3 my-4">
              <div class="flex-1 h-px bg-card-border"></div>
              <span class="text-xs text-muted font-medium">o con email</span>
              <div class="flex-1 h-px bg-card-border"></div>
            </div>

            <!-- Register form -->
            <form method="POST" class="space-y-4" id="register-form">
              <input type="hidden" name="action" value="register" />
              <div>
                <label class="block text-sm font-medium text-ink mb-1.5">Email</label>
                <input
                  type="email"
                  name="email"
                  required
                  autocomplete="email"
                  placeholder="tu@email.com"
                  class="w-full rounded-xl border border-card-border bg-white px-4 py-2.5 text-ink placeholder-muted text-sm transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-ink mb-1.5">Contrase√±a</label>
                <div class="relative">
                  <input
                    type="password"
                    name="password"
                    id="pw-input"
                    required
                    minlength="8"
                    autocomplete="new-password"
                    placeholder="M√≠nimo 8 caracteres"
                    class="w-full rounded-xl border border-card-border bg-white px-4 py-2.5 pr-10 text-ink placeholder-muted text-sm transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
                  />
                  <button type="button" id="pw-toggle" class="absolute right-3 top-1/2 -translate-y-1/2 text-muted hover:text-ink transition-colors" tabindex="-1">
                    <svg id="pw-eye-off" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
                    <svg id="pw-eye-on" class="h-4 w-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                  </button>
                </div>
                <!-- Strength bar -->
                <div class="mt-1.5 h-1 w-full rounded-full bg-card-border overflow-hidden">
                  <div id="strength-bar" style="width:0%;height:100%;border-radius:2px;transition:width 0.3s,background-color 0.3s;"></div>
                </div>
                <p id="strength-label" class="text-[10px] mt-0.5 hidden"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-ink mb-1.5">Confirmar contrase√±a</label>
                <div class="relative">
                  <input
                    type="password"
                    name="confirm_password"
                    id="pw-confirm"
                    required
                    minlength="8"
                    autocomplete="new-password"
                    placeholder="Repite tu contrase√±a"
                    class="w-full rounded-xl border border-card-border bg-white px-4 py-2.5 pr-16 text-ink placeholder-muted text-sm transition-all duration-200 hover:border-gray-300 focus:border-accent focus:outline-none focus:ring-2 focus:ring-accent/20"
                  />
                  <button type="button" id="pw-confirm-clear" class="absolute right-8 top-1/2 -translate-y-1/2 text-muted hover:text-ink transition-colors hidden" tabindex="-1">
                    <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6M9 9l6 6"/></svg>
                  </button>
                  <div id="match-icon" class="absolute right-3 top-1/2 -translate-y-1/2 hidden">
                    <svg id="match-ok" class="h-4 w-4 text-accent hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>
                    <svg id="match-no" class="h-4 w-4 text-red-500 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  </div>
                </div>
                <p id="match-error" class="text-xs text-red-500 mt-1 hidden">Las contrase√±as no coinciden.</p>
              </div>

              <button
                type="submit"
                id="btn-register"
                class="w-full rounded-xl px-6 py-3 text-sm font-semibold text-white transition-all duration-200 active:scale-95"
                style="background:#F97316; box-shadow:0 4px 14px rgba(249,115,22,0.35);"
                onmouseover="this.style.background='#EA6C0A'"
                onmouseout="this.style.background='#F97316'"
              >
                Crear cuenta
              </button>
            </form>

            <p class="mt-5 text-center text-sm text-muted">
              ¬øYa tienes cuenta?
              <a href="/login" class="font-semibold text-accent hover:text-accent-dark ml-1">Entrar ‚Üí</a>
            </p>
          </div>
        )}
      </div>
    </div>

    <script is:inline>
      function setupRegister() {
        // Google loading state
        var googleFormReg = document.getElementById('google-form-reg');
        var btnGoogleReg = document.getElementById('btn-google-reg');
        if (googleFormReg) {
          googleFormReg.addEventListener('submit', function() {
            var hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'action';
            hidden.value = 'google';
            googleFormReg.appendChild(hidden);
            if (btnGoogleReg) {
              btnGoogleReg.classList.add('btn-loading');
              btnGoogleReg.setAttribute('disabled', '');
            }
          });
        }

        // Password show/hide
        var pwInput = document.getElementById('pw-input');
        var pwToggle = document.getElementById('pw-toggle');
        var eyeOff = document.getElementById('pw-eye-off');
        var eyeOn = document.getElementById('pw-eye-on');
        if (pwToggle) {
          pwToggle.addEventListener('click', function() {
            var isHidden = pwInput.type === 'password';
            pwInput.type = isHidden ? 'text' : 'password';
            eyeOff.classList.toggle('hidden', isHidden);
            eyeOn.classList.toggle('hidden', !isHidden);
          });
        }

        // Password strength bar
        var strengthBar = document.getElementById('strength-bar');
        var strengthLabel = document.getElementById('strength-label');
        function getStrength(pw) {
          if (!pw) return { pct: 0, color: '#EF4444', label: '' };
          var score = 0;
          if (pw.length >= 8) score++;
          if (pw.length >= 12) score++;
          if (/[A-Z]/.test(pw)) score++;
          if (/[0-9]/.test(pw)) score++;
          if (/[^A-Za-z0-9]/.test(pw)) score++;
          if (score <= 1) return { pct: 20, color: '#EF4444', label: 'Muy d√©bil' };
          if (score === 2) return { pct: 40, color: '#F59E0B', label: 'D√©bil' };
          if (score === 3) return { pct: 65, color: '#F97316', label: 'Regular' };
          if (score === 4) return { pct: 85, color: '#22C55E', label: 'Buena' };
          return { pct: 100, color: '#16A34A', label: '¬°Excelente!' };
        }
        if (pwInput) {
          pwInput.addEventListener('input', function() {
            var s = getStrength(pwInput.value);
            strengthBar.style.width = s.pct + '%';
            strengthBar.style.backgroundColor = s.color;
            if (s.label) {
              strengthLabel.textContent = s.label;
              strengthLabel.style.color = s.color;
              strengthLabel.classList.remove('hidden');
            } else {
              strengthLabel.classList.add('hidden');
            }
            checkMatch();
          });
        }

        // Confirm match indicator
        var pwConfirm = document.getElementById('pw-confirm');
        var matchIcon = document.getElementById('match-icon');
        var matchOk = document.getElementById('match-ok');
        var matchNo = document.getElementById('match-no');
        var matchError = document.getElementById('match-error');
        function checkMatch() {
          if (!pwConfirm.value) { matchIcon.classList.add('hidden'); matchError.classList.add('hidden'); return; }
          var match = pwInput.value === pwConfirm.value;
          matchIcon.classList.remove('hidden');
          matchOk.classList.toggle('hidden', !match);
          matchNo.classList.toggle('hidden', match);
          matchError.classList.toggle('hidden', match);
        }
        if (pwConfirm) pwConfirm.addEventListener('input', checkMatch);

        // Clear button for confirm password
        var clearBtn = document.getElementById('pw-confirm-clear');
        if (clearBtn && pwConfirm) {
          pwConfirm.addEventListener('input', function() {
            clearBtn.classList.toggle('hidden', !pwConfirm.value);
          });
          clearBtn.addEventListener('click', function() {
            pwConfirm.value = '';
            clearBtn.classList.add('hidden');
            matchIcon.classList.add('hidden');
            matchError.classList.add('hidden');
            pwConfirm.focus();
          });
        }

        // Submit
        var form = document.getElementById('register-form');
        if (form) {
          form.addEventListener('submit', function(e) {
            var pw = form.querySelector('input[name="password"]').value;
            var conf = form.querySelector('input[name="confirm_password"]').value;
            if (pw !== conf) {
              e.preventDefault();
              matchError.classList.remove('hidden');
              pwConfirm.focus();
              return;
            }
            var btn = document.getElementById('btn-register');
            if (btn) {
              btn.classList.add('btn-loading');
              btn.setAttribute('disabled', '');
            }
          });
        }
      }
      document.addEventListener('astro:page-load', setupRegister);
    </script>
  </body>
</html>
