---
import MainLayout from '../layouts/MainLayout.astro';
import PetHeader from '../components/PetHeader.astro';
import Card from '../components/ui/Card.astro';
import Button from '../components/ui/Button.astro';
import { formatDate, isBirthday } from '../lib/utils';

const { supabase, user } = Astro.locals;

// Get the user's pet (only one in v1)
const { data: pet } = await supabase
  .from('pets')
  .select('*')
  .eq('user_id', user.id)
  .single();

if (!pet) {
  return Astro.redirect('/perfil?new=1');
}

// Get last grooming
const { data: lastGrooming } = await supabase
  .from('groomings')
  .select('type, date')
  .eq('pet_id', pet.id)
  .order('date', { ascending: false })
  .limit(1)
  .single();

// Get last adventure
const { data: lastAdventure } = await supabase
  .from('adventures')
  .select('title, date, photo_url')
  .eq('pet_id', pet.id)
  .order('date', { ascending: false })
  .limit(1)
  .single();

// Get last flight
const { data: lastFlight } = await supabase
  .from('flights')
  .select('origin, destination, flight_date, airline')
  .eq('pet_id', pet.id)
  .order('flight_date', { ascending: false })
  .limit(1)
  .single();

// Counts for summary row
const { count: vaccineCount } = await supabase
  .from('vaccines').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id);
const { count: visitCount } = await supabase
  .from('vet_visits').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id);
const { count: adventureCount } = await supabase
  .from('adventures').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id);
const birthday = pet.birth_date ? isBirthday(pet.birth_date) : false;
---

<MainLayout title="Dashboard">
  {/* Birthday Banner */}
  {birthday && (
    <div class="relative -mx-4 -mt-6 mb-0 overflow-hidden sm:-mx-6 animate-fade-up">
      <div class="bg-gradient-to-r from-amber/20 via-amber/30 to-amber/20 px-4 py-3 text-center">
        <p class="text-sm font-bold text-amber-dark">
          ðŸŽ‚ Â¡Hoy es el cumpleaÃ±os de {pet.name}! ðŸŽ‰
        </p>
      </div>
    </div>
  )}

  <!-- Hero Banner with blurred pet photo -->
  <div class:list={['relative -mx-4 mb-6 overflow-hidden rounded-b-3xl sm:-mx-6 animate-fade-up', !birthday && '-mt-6']}>
    <div class="absolute inset-0">
      {pet.photo_url ? (
        <img src={pet.photo_url} alt="" class="h-full w-full object-cover blur-2xl scale-110 opacity-25" />
      ) : (
        <div class="h-full w-full bg-gradient-to-br from-forest/5 to-amber/5"></div>
      )}
      <div class="absolute inset-0 bg-gradient-to-b from-cream/40 to-cream"></div>
    </div>
    <div class="relative px-4 pt-8 pb-6 sm:px-6">
      <PetHeader pet={pet} showEditButton />
    </div>
  </div>

  <!-- Summary Counters -->
  <div class="grid grid-cols-3 gap-3 mb-6 animate-fade-up animate-fade-up-delay-1">
    <a href="/salud/vacunas" class="rounded-2xl bg-forest/5 px-4 py-3 text-center transition-all hover:bg-forest/10 active:scale-95">
      <p class="text-xl font-bold text-forest">{vaccineCount ?? 0}</p>
      <p class="text-[11px] text-gray-400 font-medium">Vacunas</p>
    </a>
    <a href="/salud/historial" class="rounded-2xl bg-amber/10 px-4 py-3 text-center transition-all hover:bg-amber/15 active:scale-95">
      <p class="text-xl font-bold text-amber-dark">{visitCount ?? 0}</p>
      <p class="text-[11px] text-gray-400 font-medium">Visitas vet.</p>
    </a>
    <a href="/aventuras" class="rounded-2xl bg-sky/10 px-4 py-3 text-center transition-all hover:bg-sky/15 active:scale-95">
      <p class="text-xl font-bold text-sky">{adventureCount ?? 0}</p>
      <p class="text-[11px] text-gray-400 font-medium">Aventuras</p>
    </a>
  </div>

  <!-- Quick Stats Grid -->
  <div class="grid grid-cols-2 gap-3 sm:gap-4 mb-6">
    <!-- Last Grooming -->
    <a href="/salud/grooming" class="group animate-fade-up animate-fade-up-delay-2">
      <Card variant="elevated" class="h-full">
        <div class="flex items-start gap-3">
          <div class="rounded-xl bg-gradient-to-br from-pink-50 to-pink-100/50 p-2.5 text-pink-500">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs text-gray-400 font-medium">Ãšltimo grooming</p>
            {lastGrooming ? (
              <>
                <p class="text-sm font-semibold text-gray-800 truncate">{lastGrooming.type}</p>
                <p class="text-xs text-gray-400">{formatDate(lastGrooming.date)}</p>
              </>
            ) : (
              <p class="text-sm text-gray-400">Sin registros</p>
            )}
          </div>
        </div>
      </Card>
    </a>

    <!-- Weight -->
    <a href="/salud/peso" class="group animate-fade-up animate-fade-up-delay-2">
      <Card variant="elevated" class="h-full">
        <div class="flex items-start gap-3">
          <div class="rounded-xl bg-gradient-to-br from-amber-50 to-amber-100/50 p-2.5 text-amber-dark">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/></svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs text-gray-400 font-medium">Peso actual</p>
            {pet.weight_kg ? (
              <p class="text-lg font-bold text-gray-800">{pet.weight_kg} <span class="text-sm font-normal text-gray-400">kg</span></p>
            ) : (
              <p class="text-sm text-gray-400">Sin registrar</p>
            )}
          </div>
        </div>
      </Card>
    </a>

    <!-- Last Adventure -->
    <a href="/aventuras" class="group animate-fade-up animate-fade-up-delay-3">
      <Card variant="elevated" class="h-full">
        <div class="flex items-start gap-3">
          <div class="rounded-xl bg-gradient-to-br from-sky/10 to-sky/20 p-2.5 text-sky">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs text-gray-400 font-medium">Ãšltima aventura</p>
            {lastAdventure ? (
              <>
                <p class="text-sm font-semibold text-gray-800 truncate">{lastAdventure.title}</p>
                <p class="text-xs text-gray-400">{formatDate(lastAdventure.date)}</p>
              </>
            ) : (
              <p class="text-sm text-gray-400">Sin aventuras</p>
            )}
          </div>
        </div>
      </Card>
    </a>

    <!-- Last Flight -->
    <a href="/viajes" class="group animate-fade-up animate-fade-up-delay-3">
      <Card variant="elevated" class="h-full">
        <div class="flex items-start gap-3">
          <div class="rounded-xl bg-gradient-to-br from-purple-50 to-purple-100/50 p-2.5 text-purple-600">
            <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>
          </div>
          <div class="min-w-0 flex-1">
            <p class="text-xs text-gray-400 font-medium">Ãšltimo vuelo</p>
            {lastFlight ? (
              <>
                <p class="text-sm font-semibold text-gray-800 truncate">{lastFlight.origin} â†’ {lastFlight.destination}</p>
                <p class="text-xs text-gray-400">{formatDate(lastFlight.flight_date)}</p>
              </>
            ) : (
              <p class="text-sm text-gray-400">Sin vuelos</p>
            )}
          </div>
        </div>
      </Card>
    </a>
  </div>

  <!-- Quick Actions -->
  <Card variant="elevated" class="animate-fade-up animate-fade-up-delay-4">
    <h2 class="text-xs font-semibold text-gray-400 uppercase tracking-widest mb-4">Acciones rÃ¡pidas</h2>
    <div class="grid grid-cols-2 gap-3">
      <Button href="/salud/vacunas" variant="primary" size="md" class="w-full">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/></svg>
        Vacunas
      </Button>
      <Button href="/aventuras" variant="secondary" size="md" class="w-full">
        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        Nueva foto
      </Button>
      <Button href="/salud/peso" variant="ghost" size="md" class="w-full">
        Control de peso
      </Button>
      <Button href="/viajes" variant="ghost" size="md" class="w-full">
        Registrar vuelo
      </Button>
    </div>
  </Card>
</MainLayout>
