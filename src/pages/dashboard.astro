---
import MainLayout from '../layouts/MainLayout.astro';
import { formatDate, isBirthday, calculateAge } from '../lib/utils';
import { getVaccineBadge } from '../lib/vaccine-badges';
import { getActivePet } from '../lib/pet';

const { supabase, user, activePetId } = Astro.locals;
const isNewlyOnboarded = Astro.url.searchParams.get('onboarded') === '1';

const { pet } = await getActivePet(supabase, user.id, activePetId);

if (!pet) {
  return Astro.redirect('/onboarding');
}

const [
  { data: groomingRows },
  { data: adventureRows },
  { data: flightRows },
  { count: vaccineCount },
  { count: visitCount },
  { count: adventureCount },
  { data: weightRecords },
  { data: recentVaccines },
  { data: foods },
] = await Promise.all([
  supabase.from('groomings').select('type, date').eq('pet_id', pet.id).order('date', { ascending: false }).limit(1),
  supabase.from('adventures').select('title, date, photo_url').eq('pet_id', pet.id).order('date', { ascending: false }).limit(1),
  supabase.from('flights').select('origin, destination, flight_date').eq('pet_id', pet.id).order('flight_date', { ascending: false }).limit(1),
  supabase.from('vaccines').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('vet_visits').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('adventures').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('weight_records').select('weight_kg, date').eq('pet_id', pet.id).order('date', { ascending: false }).limit(2),
  supabase.from('vaccines').select('name').eq('pet_id', pet.id).order('date_given', { ascending: false }).limit(4),
  supabase.from('foods').select('brand, daily_grams, bag_size, bag_unit, price').eq('pet_id', pet.id).order('created_at', { ascending: false }),
]);

const lastGrooming = groomingRows?.[0] ?? null;
const lastAdventure = adventureRows?.[0] ?? null;
const lastFlight = flightRows?.[0] ?? null;

// Food insights
function bagToGrams(size: number, unit: string): number {
  if (unit === 'kg') return size * 1000;
  if (unit === 'lb') return size * 453.592;
  return size;
}

const activeFoods = (foods ?? []).filter(f => f.daily_grams && f.bag_size);
const currentFood = activeFoods[0] ?? null;

// Days remaining on current bag
const currentDays = currentFood
  ? Math.floor(bagToGrams(currentFood.bag_size, currentFood.bag_unit ?? 'kg') / currentFood.daily_grams)
  : null;

// Average bag duration across all foods with enough data
const allDurations = activeFoods.map(f =>
  Math.floor(bagToGrams(f.bag_size, f.bag_unit ?? 'kg') / f.daily_grams)
);
const avgDays = allDurations.length
  ? Math.round(allDurations.reduce((a, b) => a + b, 0) / allDurations.length)
  : null;

// Average cost per day across foods that have price + enough data
const foodsWithCost = activeFoods.filter(f => f.price);
const avgCostPerDay = foodsWithCost.length
  ? (foodsWithCost.reduce((sum, f) => {
      const days = bagToGrams(f.bag_size, f.bag_unit ?? 'kg') / f.daily_grams;
      return sum + f.price / days;
    }, 0) / foodsWithCost.length).toFixed(2)
  : null;

const showFoodCard = !!(currentDays || avgDays || avgCostPerDay);

const birthday = pet.birth_date ? isBirthday(pet.birth_date) : false;
const age = pet.birth_date ? calculateAge(pet.birth_date) : null;
const photoUrl = pet.photo_url || '/icons/default-pet.svg';

// Weight trend
const latestWeight = weightRecords?.[0]?.weight_kg ?? pet.weight_kg;
const prevWeight = weightRecords?.[1]?.weight_kg;
const weightDiff = latestWeight && prevWeight ? +(latestWeight - prevWeight).toFixed(1) : null;

// Checklist â€” only show items the user hasn't completed yet
const profileComplete = !!(pet.photo_url && pet.chip_id && (pet as any).color);
const checklistItems = [
  { done: (vaccineCount ?? 0) > 0,   href: '/salud/vacunas?new=1', label: 'Agregar vacuna',           sub: 'Rabia, Parvovirus, Moquillo u otras',           iconColor: 'bg-accent/10', iconStroke: 'text-accent',    icon: '<path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/>' },
  { done: (visitCount ?? 0) > 0,     href: '/salud/citas?new=1',  label: 'Agregar cita veterinaria', sub: 'Registra visitas al vet y prÃ³ximas citas',       iconColor: 'bg-blue-50',   iconStroke: 'text-blue-500',  icon: '<rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>' },
  { done: (weightRecords?.length ?? 0) > 0, href: '/salud/peso?new=1', label: 'Registrar peso',      sub: 'Lleva el historial de peso desde hoy',          iconColor: 'bg-sky-50',    iconStroke: 'text-sky-500',   icon: '<circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/>' },
  { done: (adventureCount ?? 0) > 0, href: '/aventuras?new=1',     label: 'Subir primera foto',       sub: `Guarda los mejores momentos de ${pet.name}`,    iconColor: 'bg-pink-50',   iconStroke: 'text-pink-500',  icon: '<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>' },
  { done: profileComplete,            href: '/perfil',              label: 'Completar perfil',          sub: 'Foto, microchip, color de pelaje',               iconColor: 'bg-amber/10',  iconStroke: 'text-amber-dark',icon: '<circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/>' },
].filter(item => !item.done);
---

<MainLayout title="Inicio">

  {/* â”€â”€ QUICK START CHECKLIST (smart: only pending items, hidden when all done or dismissed) â”€â”€ */}
  {checklistItems.length > 0 && (
    <div class="mb-5 animate-fade-up" id="onboarding-checklist">
      {/* Header */}
      <div class="rounded-t-2xl border border-b-0 border-accent/30 bg-accent/10 px-5 py-4">
        <div class="flex items-center gap-3">
          <span class="text-xl">ðŸš€</span>
          <div>
            <p class="text-sm font-bold text-accent-dark">Primeros pasos con {pet.name}</p>
            <p class="text-xs text-muted mt-0.5">{checklistItems.length} {checklistItems.length === 1 ? 'paso pendiente' : 'pasos pendientes'} para sacarle el mÃ¡ximo a PetLog.</p>
          </div>
        </div>
      </div>

      {/* Adult dog message â€” only post-onboarding */}
      {isNewlyOnboarded && age && !age.includes('mes') && !age.startsWith('0') && (
        <div class="border-x border-accent/30 bg-amber/5 px-5 py-3">
          <div class="flex items-start gap-2">
            <span class="text-base shrink-0 mt-0.5">ðŸ’¡</span>
            <p class="text-xs text-amber-dark leading-relaxed">
              No importa si {pet.name} es mayor â€” PetLog te ayuda a llevar su historial desde hoy.
            </p>
          </div>
        </div>
      )}

      {/* Checklist items â€” server-rendered, only pending */}
      <div class="rounded-b-2xl border border-t-0 border-accent/30 bg-white divide-y divide-card-border">
        {checklistItems.map(item => (
          <a href={item.href} class="flex items-center gap-3 px-5 py-3.5 hover:bg-canvas transition-colors active:scale-95">
            <div class:list={['flex h-8 w-8 shrink-0 items-center justify-center rounded-full', item.iconColor]}>
              <svg class:list={['h-4 w-4', item.iconStroke]} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" set:html={item.icon} />
            </div>
            <div class="flex-1">
              <p class="text-sm font-semibold text-ink">{item.label}</p>
              <p class="text-xs text-muted">{item.sub}</p>
            </div>
            <svg class="h-4 w-4 text-muted/40 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          </a>
        ))}
      </div>

      {/* Dismiss â€” persists via localStorage */}
      <button
        type="button"
        id="btn-dismiss-checklist"
        class="mt-2 w-full text-xs text-muted hover:text-ink transition-colors py-1"
      >
        Ya lo sÃ©, no mostrar de nuevo â†’
      </button>
    </div>
  )}

  <script is:inline>
    (function() {
      if (localStorage.getItem('petlog_checklist_hidden') === '1') {
        var el = document.getElementById('onboarding-checklist');
        if (el) el.style.display = 'none';
      }
    })();
  </script>
  <script>
    document.getElementById('btn-dismiss-checklist')?.addEventListener('click', () => {
      localStorage.setItem('petlog_checklist_hidden', '1');
      const el = document.getElementById('onboarding-checklist');
      if (el) el.style.display = 'none';
    });
  </script>

  {/* Confetti â€” only on first arrival after onboarding */}
  {isNewlyOnboarded && (
    <script is:inline>
      (function() {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js';
        script.onload = function() {
          setTimeout(function() {
            window.confetti({ particleCount: 140, spread: 90, origin: { y: 0.55 },
              colors: ['#7CB974','#5FA356','#ffffff','#F59E0B','#EAF5E8'] });
          }, 300);
        };
        document.head.appendChild(script);
      })();
    </script>
  )}

  {/* Birthday Banner */}
  {birthday && (
    <div class="mb-5 rounded-2xl border border-amber/30 bg-amber/10 px-4 py-3 text-center animate-fade-up">
      <p class="text-sm font-semibold text-amber-dark">ðŸŽ‚ Â¡Hoy es el cumpleaÃ±os de {pet.name}! ðŸŽ‰</p>
    </div>
  )}

  {/* â”€â”€ HERO CARD â”€â”€ */}
  <a href="/perfil" class="block mb-5 animate-fade-up">
    <div class="relative rounded-2xl overflow-hidden" style="background-color: color-mix(in srgb, var(--color-accent) 25%, #0a0f0a);">
      {/* Subtle noise/gradient overlay */}
      <div class="absolute inset-0 bg-linear-to-br from-white/5 to-transparent pointer-events-none"></div>

      <div class="relative flex items-center gap-4 p-5">
        {/* Avatar */}
        <div class="relative shrink-0">
          <img
            src={photoUrl}
            alt={pet.name}
            class:list={[
              'h-20 w-20 rounded-2xl object-cover',
              birthday ? 'ring-2 ring-amber ring-offset-2' : 'ring-1 ring-white/10',
            ]}
            style={birthday ? 'ring-offset-color: color-mix(in srgb, var(--color-accent) 25%, #0a0f0a);' : ''}
          />
          {birthday && <span class="absolute -top-2 -right-2 text-base animate-bounce">ðŸŽ‚</span>}
          {pet.gender && !birthday && (
            <span class="absolute -bottom-1 -right-1 rounded-full bg-white/10 border border-white/10 px-1.5 py-0.5 text-xs text-white/60">
              {pet.gender === 'macho' ? 'â™‚' : 'â™€'}
            </span>
          )}
        </div>

        {/* Info */}
        <div class="flex-1 min-w-0">
          <p class="text-xs font-medium text-white/40 uppercase tracking-widest mb-0.5">Mi mascota</p>
          <h1 class="text-2xl font-bold text-white tracking-tight truncate">{pet.name}</h1>
          <div class="flex flex-wrap items-center gap-x-2 gap-y-0.5 mt-1">
            {pet.breed && <span class="text-sm text-white/60">{pet.breed}</span>}
            {age && pet.breed && <span class="text-white/30 text-sm">Â·</span>}
            {age && <span class="text-sm text-white/60">{age}</span>}
          </div>
        </div>

        {/* Arrow */}
        <div class="shrink-0 text-white/20">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 18 6-6-6-6"/>
          </svg>
        </div>
      </div>

      {/* Chips row */}
      {(pet.weight_kg || pet.chip_id) && (
        <div class="relative flex gap-2 px-5 pb-4">
          {pet.weight_kg && (
            <span class="inline-flex items-center gap-1.5 rounded-full bg-white/8 px-3 py-1 text-xs font-medium text-white/70">
              <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/></svg>
              {pet.weight_kg} kg
            </span>
          )}
          {pet.chip_id && (
            <span class="inline-flex items-center gap-1.5 rounded-full bg-white/8 px-3 py-1 text-xs font-medium text-white/70">
              <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="7" y="7" width="10" height="10" rx="1"/><path d="M7 12H3M17 12h4M12 7V3M12 17v4"/></svg>
              Chip
            </span>
          )}
        </div>
      )}
    </div>
  </a>

  {/* â”€â”€ STATS ROW â”€â”€ */}
  <div class="grid grid-cols-3 gap-3 mb-5 animate-fade-up animate-fade-up-delay-1">
    <a href="/salud/vacunas" class="group rounded-2xl bg-card border border-card-border p-4 text-center transition-all duration-200 hover:border-accent/40 hover:shadow-sm active:scale-95">
      <p class="text-3xl font-black text-ink tracking-tight">{vaccineCount ?? 0}</p>
      <p class="text-[11px] text-muted font-medium mt-0.5 leading-tight">Vacunas</p>
    </a>
    <a href="/salud/historial" class="group rounded-2xl bg-card border border-card-border p-4 text-center transition-all duration-200 hover:border-amber/40 hover:shadow-sm active:scale-95">
      <p class="text-3xl font-black text-ink tracking-tight">{visitCount ?? 0}</p>
      <p class="text-[11px] text-muted font-medium mt-0.5 leading-tight">Visitas vet.</p>
    </a>
    <a href="/aventuras" class="group rounded-2xl bg-card border border-card-border p-4 text-center transition-all duration-200 hover:border-sky-300 hover:shadow-sm active:scale-95">
      <p class="text-3xl font-black text-ink tracking-tight">{adventureCount ?? 0}</p>
      <p class="text-[11px] text-muted font-medium mt-0.5 leading-tight">Aventuras</p>
    </a>
  </div>

  {/* â”€â”€ WEIGHT CARD (dark) â”€â”€ */}
  <a href="/salud/peso" class="block mb-5 animate-fade-up animate-fade-up-delay-1">
    <div class="relative rounded-2xl bg-accent overflow-hidden">
      <div class="absolute inset-0 bg-linear-to-br from-white/10 to-transparent pointer-events-none"></div>
      <div class="relative flex items-center justify-between px-5 py-4">
        <div>
          <p class="text-xs font-medium text-white/60 uppercase tracking-widest mb-1">Peso actual</p>
          {latestWeight ? (
            <div class="flex items-baseline gap-2">
              <p class="text-4xl font-black text-white tracking-tight">{latestWeight}</p>
              <p class="text-lg font-medium text-white/60">kg</p>
              {weightDiff !== null && (
                <span class:list={[
                  'inline-flex items-center gap-0.5 rounded-full px-2 py-0.5 text-xs font-semibold',
                  weightDiff > 0 ? 'bg-white/15 text-white' : weightDiff < 0 ? 'bg-white/15 text-white' : 'bg-white/10 text-white/60'
                ]}>
                  {weightDiff > 0 ? 'â†‘' : weightDiff < 0 ? 'â†“' : 'â€”'} {Math.abs(weightDiff)} kg
                </span>
              )}
            </div>
          ) : (
            <p class="text-2xl font-bold text-white/60">Sin registrar</p>
          )}
        </div>
        <div class="flex items-center justify-center h-12 w-12 rounded-2xl bg-white/15">
          <svg class="h-6 w-6 text-white" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/></svg>
        </div>
      </div>
    </div>
  </a>

  {/* â”€â”€ FOOD INSIGHTS CARD â”€â”€ */}
  {showFoodCard && (
    <a href="/alimentacion" class="block mb-5 animate-fade-up animate-fade-up-delay-1">
      <div class="rounded-2xl bg-card border border-card-border p-4 transition-all duration-200 hover:shadow-sm hover:border-amber/30 active:scale-95">
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2.5">
            <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-amber/10">
              <svg class="h-4.5 w-4.5 text-amber-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
            </div>
            <div>
              <p class="text-sm font-semibold text-ink">AlimentaciÃ³n</p>
              {currentFood && <p class="text-[11px] text-muted truncate max-w-40">{currentFood.brand}</p>}
            </div>
          </div>
          <svg class="h-4 w-4 text-muted/40 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
        </div>

        <div class="grid grid-cols-3 gap-3 pt-2 border-t border-card-border">
          <div class="text-center">
            <p class:list={['text-xl font-black tracking-tight', currentDays ? 'text-ink' : 'text-muted/40']}>
              {currentDays ? `â‰ˆ${currentDays}` : 'â€”'}
            </p>
            <p class="text-[10px] text-muted font-medium mt-0.5 leading-tight">dÃ­as<br/>restantes</p>
          </div>
          <div class="text-center border-x border-card-border">
            <p class:list={['text-xl font-black tracking-tight', avgDays ? 'text-ink' : 'text-muted/40']}>
              {avgDays ?? 'â€”'}
            </p>
            <p class="text-[10px] text-muted font-medium mt-0.5 leading-tight">dÃ­as<br/>por bolsa</p>
          </div>
          <div class="text-center">
            <p class:list={['text-xl font-black tracking-tight', avgCostPerDay ? 'text-ink' : 'text-muted/40']}>
              {avgCostPerDay ? `$${avgCostPerDay}` : 'â€”'}
            </p>
            <p class="text-[10px] text-muted font-medium mt-0.5 leading-tight">costo<br/>por dÃ­a</p>
          </div>
        </div>
      </div>
    </a>
  )}

  {/* â”€â”€ RECENT ACTIVITY GRID â”€â”€ */}
  <p class="text-xs font-semibold text-muted uppercase tracking-widest mb-3 animate-fade-up animate-fade-up-delay-2">Actividad reciente</p>
  <div class="grid grid-cols-2 gap-3 mb-5 animate-fade-up animate-fade-up-delay-2">

    {/* Grooming */}
    <a href="/salud/grooming" class="rounded-2xl bg-card border border-card-border p-4 transition-all duration-200 hover:shadow-sm hover:border-pink-200 active:scale-95">
      <div class="flex items-center justify-between mb-3">
        <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-pink-50">
          <svg class="h-4.5 w-4.5 text-pink-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>
        </div>
        <svg class="h-4 w-4 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>
      <p class="text-[11px] text-muted font-medium mb-0.5">Grooming</p>
      {lastGrooming ? (
        <>
          <p class="text-sm font-semibold text-ink leading-tight truncate">{lastGrooming.type}</p>
          <p class="text-[11px] text-muted mt-0.5">{formatDate(lastGrooming.date)}</p>
        </>
      ) : (
        <p class="text-sm text-muted">Sin registros</p>
      )}
    </a>

    {/* Aventura */}
    <a href="/aventuras" class="rounded-2xl bg-card border border-card-border p-4 transition-all duration-200 hover:shadow-sm hover:border-sky-200 active:scale-95 overflow-hidden relative">
      {lastAdventure?.photo_url && (
        <div class="absolute inset-0">
          <img src={lastAdventure.photo_url} alt="" class="h-full w-full object-cover opacity-15" />
          <div class="absolute inset-0 bg-linear-to-t from-card via-card/80 to-card/20"></div>
        </div>
      )}
      <div class="relative flex items-center justify-between mb-3">
        <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-sky-50">
          <svg class="h-4.5 w-4.5 text-sky-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
        </div>
        <svg class="h-4 w-4 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>
      <p class="relative text-[11px] text-muted font-medium mb-0.5">Aventura</p>
      {lastAdventure ? (
        <>
          <p class="relative text-sm font-semibold text-ink leading-tight truncate">{lastAdventure.title}</p>
          <p class="relative text-[11px] text-muted mt-0.5">{formatDate(lastAdventure.date)}</p>
        </>
      ) : (
        <p class="relative text-sm text-muted">Sin aventuras</p>
      )}
    </a>

    {/* Vacunas badges */}
    <a href="/salud/vacunas" class="rounded-2xl bg-card border border-card-border p-4 transition-all duration-200 hover:shadow-sm hover:border-accent/30 active:scale-95">
      <div class="flex items-center justify-between mb-3">
        <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-accent/10">
          <svg class="h-4.5 w-4.5 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/></svg>
        </div>
        <svg class="h-4 w-4 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>
      <p class="text-[11px] text-muted font-medium mb-2">Vacunas</p>
      {recentVaccines && recentVaccines.length > 0 ? (
        <div class="flex gap-2.5">
          {recentVaccines.map((v) => {
            const { src, label } = getVaccineBadge(v.name);
            return (
              <div class="flex flex-col items-center gap-0.5">
                {src ? (
                  <img src={src} alt={label} class="h-10 w-10 object-contain drop-shadow-sm" />
                ) : (
                  <div class="h-10 w-10 rounded-xl bg-accent/10 flex items-center justify-center">
                    <svg class="h-5 w-5 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/></svg>
                  </div>
                )}
                <p class="text-[9px] text-muted text-center leading-tight truncate max-w-10">{label}</p>
              </div>
            );
          })}
        </div>
      ) : (
        <p class="text-sm text-muted">Sin vacunas</p>
      )}
    </a>

    {/* Vuelos */}
    <a href="/viajes" class="rounded-2xl bg-card border border-card-border p-4 transition-all duration-200 hover:shadow-sm hover:border-purple-200 active:scale-95">
      <div class="flex items-center justify-between mb-3">
        <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-purple-50">
          <svg class="h-4.5 w-4.5 text-purple-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.8 19.2 16 11l3.5-3.5C21 6 21.5 4 21 3c-1-.5-3 0-4.5 1.5L13 8 4.8 6.2c-.5-.1-.9.1-1.1.5l-.3.5c-.2.5-.1 1 .3 1.3L9 12l-2 3H4l-1 1 3 2 2 3 1-1v-3l3-2 3.5 5.3c.3.4.8.5 1.3.3l.5-.2c.4-.3.6-.7.5-1.2z"/></svg>
        </div>
        <svg class="h-4 w-4 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>
      <p class="text-[11px] text-muted font-medium mb-0.5">Vuelo</p>
      {lastFlight ? (
        <>
          <p class="text-sm font-semibold text-ink leading-tight">{lastFlight.origin} â†’ {lastFlight.destination}</p>
          <p class="text-[11px] text-muted mt-0.5">{formatDate(lastFlight.flight_date)}</p>
        </>
      ) : (
        <p class="text-sm text-muted">Sin vuelos</p>
      )}
    </a>
  </div>

  {/* â”€â”€ QUICK ACTIONS â”€â”€ */}
  <p class="text-xs font-semibold text-muted uppercase tracking-widest mb-3 animate-fade-up animate-fade-up-delay-3">Acciones rÃ¡pidas</p>
  <div class="grid grid-cols-2 gap-3 animate-fade-up animate-fade-up-delay-3">
    <a href="/salud/vacunas" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-accent/30 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-accent/10">
        <svg class="h-4.5 w-4.5 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Vacunas</p>
        <p class="text-[11px] text-muted">Ver historial</p>
      </div>
    </a>
    <a href="/aventuras" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-sky-200 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-sky-50">
        <svg class="h-4.5 w-4.5 text-sky-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Nueva foto</p>
        <p class="text-[11px] text-muted">Registrar aventura</p>
      </div>
    </a>
    <a href="/salud/peso" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-amber/30 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-amber/10">
        <svg class="h-4.5 w-4.5 text-amber-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Peso</p>
        <p class="text-[11px] text-muted">Registrar nuevo</p>
      </div>
    </a>
    <a href="/alimentacion" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-amber/30 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-amber/10">
        <svg class="h-4.5 w-4.5 text-amber-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">AlimentaciÃ³n</p>
        <p class="text-[11px] text-muted">Ver dieta</p>
      </div>
    </a>
  </div>

</MainLayout>
