---
import MainLayout from '../layouts/MainLayout.astro';
import { formatDate, isBirthday, calculateAge } from '../lib/utils';
import { getVaccineBadge } from '../lib/vaccine-badges';
import { getActivePet } from '../lib/pet';
import { calculateVitalityScore } from '../lib/vitality-score';
import type { ScoreInput } from '../lib/vitality-score';
import { GROOMING_TYPES } from '../lib/constants';

const { supabase, user, activePetId } = Astro.locals;
const isNewlyOnboarded = Astro.url.searchParams.get('onboarded') === '1';

const { pet } = await getActivePet(supabase, user.id, activePetId);

if (!pet) {
  return Astro.redirect('/onboarding');
}

const [
  { data: groomingRows },
  { data: adventureRows },
  { data: flightRows },
  { count: vaccineCount },
  { count: visitCount },
  { count: adventureCount },
  { data: weightRecords },
  { data: recentVaccines },
  { data: foods },
  { data: lastAntipulgas },
  { data: lastDesparasitante },
] = await Promise.all([
  supabase.from('groomings').select('type, date').eq('pet_id', pet.id).order('date', { ascending: false }).limit(1),
  supabase.from('adventures').select('title, date, photo_url').eq('pet_id', pet.id).order('date', { ascending: false }).limit(1),
  supabase.from('flights').select('origin, destination, flight_date').eq('pet_id', pet.id).order('flight_date', { ascending: false }).limit(1),
  supabase.from('vaccines').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('vet_visits').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('adventures').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('weight_records').select('weight_kg, date').eq('pet_id', pet.id).order('date', { ascending: false }).limit(2),
  supabase.from('vaccines').select('name, date_given').eq('pet_id', pet.id).order('date_given', { ascending: false }).limit(4),
  supabase.from('foods').select('brand, daily_grams, bag_size, bag_unit, price, food_type, start_date, created_at').eq('pet_id', pet.id).order('created_at', { ascending: false }),
  supabase.from('preventive_treatments').select('date_given, product_name').eq('pet_id', pet.id).eq('type', 'antipulgas').order('date_given', { ascending: false }).limit(1),
  supabase.from('preventive_treatments').select('date_given, product_name').eq('pet_id', pet.id).eq('type', 'desparasitante').order('date_given', { ascending: false }).limit(1),
]);

const lastGrooming = groomingRows?.[0] ?? null;
const lastAdventure = adventureRows?.[0] ?? null;
const lastFlight = flightRows?.[0] ?? null;

// Food insights
function bagToGrams(size: number, unit: string): number {
  if (unit === 'kg') return size * 1000;
  if (unit === 'lb') return size * 453.592;
  return size;
}

const activeFoods = (foods ?? []).filter(f => f.daily_grams && f.bag_size);
const currentFood = activeFoods[0] ?? null;

const totalDays = currentFood
  ? Math.floor(bagToGrams(currentFood.bag_size, currentFood.bag_unit ?? 'kg') / currentFood.daily_grams)
  : null;

// Days elapsed since bag was opened (use start_date if set, else created_at)
const bagStartStr = currentFood?.start_date || currentFood?.created_at || null;
const daysElapsed = bagStartStr
  ? Math.floor((Date.now() - new Date(bagStartStr).getTime()) / (1000 * 60 * 60 * 24))
  : null;
const daysLeft = totalDays !== null && daysElapsed !== null
  ? Math.max(0, totalDays - daysElapsed)
  : null;


const foodsWithCost = activeFoods.filter(f => f.price);
const avgCostPerDay = foodsWithCost.length
  ? (foodsWithCost.reduce((sum, f) => {
      const days = bagToGrams(f.bag_size, f.bag_unit ?? 'kg') / f.daily_grams;
      return sum + f.price / days;
    }, 0) / foodsWithCost.length).toFixed(2)
  : null;

// Vitality Score
const vitalityInput: ScoreInput = {
  pet: {
    breed: pet.breed ?? null,
    birth_date: pet.birth_date ?? null,
    weight_kg: pet.weight_kg ?? null,
    gender: pet.gender ?? null,
    is_neutered: pet.is_neutered ?? null,
  },
  weightRecords: weightRecords ?? [],
  vaccines: recentVaccines?.map(v => ({ name: v.name, date_given: new Date().toISOString() })) ?? [],
  vetVisits: [],
  groomings: lastGrooming ? [{ date: lastGrooming.date }] : [],
  adventures: lastAdventure ? [{ date: lastAdventure.date }] : [],
  foods: activeFoods,
};
const dashScore = calculateVitalityScore(vitalityInput);

// Short pillar names for the compact bar display
const SHORT_PILLAR: Record<string, string> = {
  'Peso': 'Peso',
  'Cuidado preventivo': 'Preventivo',
  'Raza y edad': 'Raza',
  'Actividad': 'Actividad',
  'Nutrici√≥n': 'Nutrici√≥n',
};

// Preventive treatment reminders (30-day cycle)
function daysUntilNext(lastDateStr: string | null | undefined): { daysLeft: number; overdue: boolean; lastDate: string | null } {
  if (!lastDateStr) return { daysLeft: 0, overdue: true, lastDate: null };
  const last = new Date(lastDateStr);
  const next = new Date(last);
  next.setDate(next.getDate() + 30);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  next.setHours(0, 0, 0, 0);
  const daysLeft = Math.ceil((next.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
  return { daysLeft, overdue: daysLeft < 0, lastDate: lastDateStr };
}

const antipulgasInfo = daysUntilNext(lastAntipulgas?.[0]?.date_given);
const desparasitanteInfo = daysUntilNext(lastDesparasitante?.[0]?.date_given);

const birthday = pet.birth_date ? isBirthday(pet.birth_date) : false;
const age = pet.birth_date ? calculateAge(pet.birth_date) : null;
const photoUrl = pet.photo_url || '/icons/default-pet.svg';

// Weight trend
const latestWeight = weightRecords?.[0]?.weight_kg ?? pet.weight_kg;
const prevWeight = weightRecords?.[1]?.weight_kg;
const weightDiff = latestWeight && prevWeight ? +(latestWeight - prevWeight).toFixed(1) : null;

// Checklist
const profileComplete = !!(pet.photo_url && pet.chip_id && pet.color);
const checklistItems = [
  { done: (vaccineCount ?? 0) > 0,   href: '/salud/vacunas?new=1', label: 'Agregar vacuna',           sub: 'Rabia, Parvovirus, Moquillo u otras',           iconColor: 'bg-accent/10', iconStroke: 'text-accent',    icon: '<path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/>' },
  { done: (visitCount ?? 0) > 0,     href: '/salud/historial',    label: 'Agregar cita veterinaria', sub: 'Registra visitas al vet y pr√≥ximas citas',       iconColor: 'bg-blue-50',   iconStroke: 'text-blue-500',  icon: '<rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>' },
  { done: (weightRecords?.length ?? 0) > 0, href: '/salud/peso?new=1', label: 'Registrar peso',      sub: 'Lleva el historial de peso desde hoy',          iconColor: 'bg-sky-50',    iconStroke: 'text-sky-500',   icon: '<circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/>' },
  { done: (adventureCount ?? 0) > 0, href: '/aventuras?new=1',     label: 'Subir primera foto',       sub: `Guarda los mejores momentos de ${pet.name}`,    iconColor: 'bg-pink-50',   iconStroke: 'text-pink-500',  icon: '<path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/>' },
  { done: profileComplete,            href: '/perfil',              label: 'Completar perfil',          sub: 'Foto, microchip, color de pelaje',               iconColor: 'bg-amber/10',  iconStroke: 'text-amber-dark',icon: '<circle cx="12" cy="8" r="5"/><path d="M20 21a8 8 0 0 0-16 0"/>' },
].filter(item => !item.done);
---

<MainLayout title="Inicio">

  {/* ‚îÄ‚îÄ QUICK START CHECKLIST ‚îÄ‚îÄ */}
  {checklistItems.length > 0 && (
    <div class="mb-5 animate-fade-up" id="onboarding-checklist">
      <div class="rounded-t-2xl border border-b-0 border-accent/30 bg-accent/10 px-5 py-4">
        <div class="flex items-center gap-3">
          <span class="text-xl">üöÄ</span>
          <div>
            <p class="text-sm font-bold text-accent-dark">Primeros pasos con {pet.name}</p>
            <p class="text-xs text-muted mt-0.5">{checklistItems.length} {checklistItems.length === 1 ? 'paso pendiente' : 'pasos pendientes'} para sacarle el m√°ximo a PetLog.</p>
          </div>
        </div>
      </div>
      {isNewlyOnboarded && age && !age.includes('mes') && !age.startsWith('0') && (
        <div class="border-x border-accent/30 bg-amber/5 px-5 py-3">
          <div class="flex items-start gap-2">
            <span class="text-base shrink-0 mt-0.5">üí°</span>
            <p class="text-xs text-amber-dark leading-relaxed">
              No importa si {pet.name} es mayor ‚Äî PetLog te ayuda a llevar su historial desde hoy.
            </p>
          </div>
        </div>
      )}
      <div class="rounded-b-2xl border border-t-0 border-accent/30 bg-white divide-y divide-card-border">
        {checklistItems.map(item => (
          <a href={item.href} class="flex items-center gap-3 px-5 py-3.5 hover:bg-canvas transition-colors active:scale-95">
            <div class:list={['flex h-8 w-8 shrink-0 items-center justify-center rounded-full', item.iconColor]}>
              <svg class:list={['h-4 w-4', item.iconStroke]} viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" set:html={item.icon} />
            </div>
            <div class="flex-1">
              <p class="text-sm font-semibold text-ink">{item.label}</p>
              <p class="text-xs text-muted">{item.sub}</p>
            </div>
            <svg class="h-4 w-4 text-muted/40 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
          </a>
        ))}
      </div>
      <button type="button" id="btn-dismiss-checklist" class="mt-2 w-full text-xs text-muted hover:text-ink transition-colors py-1">
        Ya lo s√©, no mostrar de nuevo ‚Üí
      </button>
    </div>
  )}

  <script is:inline>
    (function() {
      if (localStorage.getItem('petlog_checklist_hidden') === '1') {
        var el = document.getElementById('onboarding-checklist');
        if (el) el.style.display = 'none';
      }
    })();
  </script>
  <script>
    document.getElementById('btn-dismiss-checklist')?.addEventListener('click', () => {
      localStorage.setItem('petlog_checklist_hidden', '1');
      const el = document.getElementById('onboarding-checklist');
      if (el) el.style.display = 'none';
    });
  </script>

  {/* ‚îÄ‚îÄ CONFETTI ‚îÄ‚îÄ */}
  {isNewlyOnboarded && (
    <script is:inline>
      (function() {
        var script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js';
        script.onload = function() {
          setTimeout(function() {
            window.confetti({ particleCount: 140, spread: 90, origin: { y: 0.55 },
              colors: ['#7CB974','#5FA356','#ffffff','#F59E0B','#EAF5E8'] });
          }, 300);
        };
        document.head.appendChild(script);
      })();
    </script>
  )}

  {/* ‚îÄ‚îÄ BIRTHDAY BANNER ‚îÄ‚îÄ */}
  {birthday && (
    <div class="mb-5 rounded-2xl border border-amber/30 bg-amber/10 px-4 py-3 text-center animate-fade-up">
      <p class="text-sm font-semibold text-amber-dark">üéÇ ¬°Hoy es el cumplea√±os de {pet.name}! üéâ</p>
    </div>
  )}

  {/* ‚îÄ‚îÄ HERO CARD ‚îÄ‚îÄ */}
  <a href="/perfil" class="block mb-5 animate-fade-up">
    <div class="relative rounded-2xl overflow-hidden" style="background-color: color-mix(in srgb, var(--color-accent) 25%, #0a0f0a);">
      <div class="absolute inset-0 bg-linear-to-br from-white/5 to-transparent pointer-events-none"></div>
      <div class="relative flex items-center gap-4 p-5">
        <div class="relative shrink-0">
          <img
            src={photoUrl}
            alt={pet.name}
            class:list={[
              'h-20 w-20 rounded-2xl object-cover',
              birthday ? 'ring-2 ring-amber ring-offset-2' : 'ring-1 ring-white/10',
            ]}
          />
          {birthday && <span class="absolute -top-2 -right-2 text-base animate-bounce">üéÇ</span>}
          {pet.gender && !birthday && (
            <span class="absolute -bottom-1 -right-1 rounded-full bg-white/10 border border-white/10 px-1.5 py-0.5 text-xs text-white/60">
              {pet.gender === 'macho' ? '‚ôÇ' : '‚ôÄ'}
            </span>
          )}
        </div>
        <div class="flex-1 min-w-0">
          <p class="text-xs font-medium text-white/40 uppercase tracking-widest mb-0.5">Mi mascota</p>
          <h1 class="text-2xl font-bold text-white tracking-tight truncate">{pet.name}</h1>
          <div class="flex flex-wrap items-center gap-x-2 gap-y-0.5 mt-1">
            {pet.breed && <span class="text-sm text-white/60">{pet.breed}</span>}
            {age && pet.breed && <span class="text-white/30 text-sm">¬∑</span>}
            {age && <span class="text-sm text-white/60">{age}</span>}
          </div>
        </div>
        <div class="shrink-0 text-white/20">
          <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 18 6-6-6-6"/>
          </svg>
        </div>
      </div>
      {(pet.weight_kg || pet.chip_id) && (
        <div class="relative flex gap-2 px-5 pb-4">
          {pet.weight_kg && (
            <span class="inline-flex items-center gap-1.5 rounded-full bg-white/8 px-3 py-1 text-xs font-medium text-white/70">
              <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/></svg>
              {pet.weight_kg} kg
            </span>
          )}
          {pet.chip_id && (
            <span class="inline-flex items-center gap-1.5 rounded-full bg-white/8 px-3 py-1 text-xs font-medium text-white/70">
              <svg class="h-3 w-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="7" y="7" width="10" height="10" rx="1"/><path d="M7 12H3M17 12h4M12 7V3M12 17v4"/></svg>
              Chip
            </span>
          )}
        </div>
      )}
    </div>
  </a>

  {/* ‚îÄ‚îÄ MIDDLE ROW: Score + Peso/Alimentaci√≥n ‚îÄ‚îÄ */}
  <div class="grid grid-cols-5 gap-3 mb-5 animate-fade-up animate-fade-up-delay-1">

    {/* Score de Bienestar ‚Äî dark card (3/5) */}
    <div class="col-span-5 sm:col-span-3 self-stretch">
      <a href="/salud" class="block h-full">
        <div class="h-full rounded-2xl p-4 flex flex-col gap-3" style="background-color: #1C1C1E;">

          {/* Icon + title */}
          <div class="flex items-start gap-3">
            <div class="shrink-0 flex h-10 w-10 items-center justify-center rounded-xl" style="background-color: rgba(124,185,116,0.18);">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="#7CB974" stroke="none">
                <path d="M12 21.593c-5.63-5.539-11-10.297-11-14.402 0-3.791 3.068-5.191 5.281-5.191 1.312 0 4.151.501 5.719 4.457 1.59-3.968 4.464-4.447 5.726-4.447 2.54 0 5.274 1.621 5.274 5.181 0 4.069-5.136 8.625-11 14.402z"/>
              </svg>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-bold text-white">Score de Bienestar</p>
              <p class="text-[11px] leading-relaxed mt-0.5" style="color: rgba(255,255,255,0.45);">
                Un n√∫mero del 0 al 100 que resume la salud de {pet.name} en 5 pilares: nutrici√≥n, actividad, peso, veterinario y vacunas.
              </p>
            </div>
          </div>

          {/* Circle + bars */}
          <div class="flex items-start gap-4">

            {/* Score circle */}
            {dashScore.showScore ? (
              <div class="relative shrink-0 h-16 w-16" aria-label={`Score: ${dashScore.total}`}>
                <svg viewBox="0 0 36 36" class="h-16 w-16 -rotate-90" aria-hidden="true">
                  <circle cx="18" cy="18" r="15.5" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="3"/>
                  <circle
                    cx="18" cy="18" r="15.5"
                    fill="none"
                    stroke={dashScore.color}
                    stroke-width="3"
                    stroke-linecap="round"
                    stroke-dasharray={`${(dashScore.total / 100) * 97.4} 97.4`}
                  />
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center">
                  <span class="text-xl font-black text-white leading-none">{dashScore.total}</span>
                  <span class="text-[8px] font-semibold uppercase tracking-widest" style="color: rgba(255,255,255,0.35);">Score</span>
                </div>
              </div>
            ) : (
              <div class="shrink-0 h-16 w-16 rounded-full flex items-center justify-center" style="border: 2.5px dashed rgba(255,255,255,0.15);">
                <span class="text-xl">üêæ</span>
              </div>
            )}

            {/* 5 pillar bars */}
            <div class="flex-1 flex flex-col justify-center gap-2">
              {dashScore.pillars.map(pillar => (
                <div class="flex items-center gap-2">
                  <p class="text-[10px] shrink-0 w-14 truncate" style="color: rgba(255,255,255,0.5);">
                    {SHORT_PILLAR[pillar.name] ?? pillar.name}
                  </p>
                  <div class="flex-1 rounded-full h-1.5 overflow-hidden" style="background-color: rgba(255,255,255,0.08);">
                    <div
                      class="h-1.5 rounded-full"
                      style={`width: ${dashScore.showScore ? pillar.pct : 0}%; background-color: #7CB974; transition: width 0.6s ease;`}
                    />
                  </div>
                  <p class="text-[10px] w-4 text-right font-semibold shrink-0" style={`color: ${dashScore.showScore ? '#7CB974' : 'rgba(255,255,255,0.2)'};`}>
                    {pillar.score}
                  </p>
                </div>
              ))}
            </div>

          </div>

          {/* Footer status */}
          <p class="text-[11px] font-medium mt-auto" style={`color: ${dashScore.color};`}>
            {dashScore.headline} ‚Üí
          </p>

        </div>
      </a>
    </div>

    {/* Right column: Peso + Alimentaci√≥n (2/5) */}
    <div class="col-span-5 sm:col-span-2 flex flex-col gap-3">

      {/* Peso compact */}
      <a href="/salud/peso" class="block rounded-2xl bg-accent overflow-hidden active:scale-95 transition-transform">
        <div class="relative px-4 py-4">
          <div class="absolute inset-0 bg-linear-to-br from-white/10 to-transparent pointer-events-none"></div>
          <p class="relative text-[10px] font-semibold text-white/50 uppercase tracking-widest mb-1">Peso actual</p>
          {latestWeight ? (
            <div class="relative flex items-baseline gap-1.5">
              <span class="text-3xl font-black text-white leading-none">{latestWeight}</span>
              <span class="text-sm text-white/60">kg</span>
            </div>
          ) : (
            <p class="relative text-sm font-semibold text-white/60">Sin registrar</p>
          )}
          {weightDiff !== null && (
            <p class="relative text-xs text-white/60 mt-1">
              {weightDiff > 0 ? '‚Üë' : '‚Üì'} {Math.abs(weightDiff)} kg
            </p>
          )}
        </div>
      </a>

      {/* Alimentaci√≥n compact */}
      <a href="/alimentacion" class="flex-1 block rounded-2xl bg-card border border-card-border px-4 py-4 active:scale-95 transition-transform hover:border-amber/30">
        <div class="flex items-center gap-2 mb-2">
          <div class="flex h-7 w-7 shrink-0 items-center justify-center rounded-lg bg-amber/10">
            <svg class="h-3.5 w-3.5 text-amber-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
          </div>
          <p class="text-xs font-semibold text-ink">Alimentaci√≥n</p>
        </div>
        {currentFood ? (
          <>
            <p class="text-sm font-bold text-ink truncate">{currentFood.brand}</p>
            {avgCostPerDay ? (
              <p class="text-xs text-muted mt-0.5">${avgCostPerDay}/d√≠a</p>
            ) : null}
            {daysLeft !== null && totalDays !== null ? (
              <p class="text-xs text-muted mt-0.5">{daysLeft}d restantes / {totalDays}d total</p>
            ) : null}
          </>
        ) : (
          <p class="text-xs text-muted/60">Agregar alimento ‚Üí</p>
        )}
      </a>

    </div>
  </div>

  {/* ‚îÄ‚îÄ BOTTOM ROW: Vacunas + Alimentaci√≥n detalle ‚îÄ‚îÄ */}
  <div class="grid grid-cols-2 gap-3 mb-5 animate-fade-up animate-fade-up-delay-2">

    {/* Vacunas list */}
    <a href="/salud/vacunas" class="rounded-2xl bg-card border border-card-border p-4 transition-all active:scale-95 hover:shadow-sm">
      <div class="flex items-center justify-between mb-3">
        <p class="text-xs font-semibold text-ink">Vacunas</p>
        <svg class="h-4 w-4 text-muted/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>
      {recentVaccines && recentVaccines.length > 0 ? (
        <div class="space-y-2.5">
          {recentVaccines.map(v => {
            const { src, label } = getVaccineBadge(v.name);
            return (
              <div class="flex items-center gap-2">
                {src ? (
                  <img src={src} alt={label} class="h-7 w-7 object-contain shrink-0 drop-shadow-sm" />
                ) : (
                  <div class="h-7 w-7 shrink-0 flex items-center justify-center rounded-lg bg-accent/10">
                    <svg class="h-3.5 w-3.5 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/></svg>
                  </div>
                )}
                <div class="flex-1 min-w-0">
                  <p class="text-[11px] font-semibold text-ink truncate">{label}</p>
                  {v.date_given && (
                    <p class="text-[10px] text-muted">{formatDate(v.date_given)}</p>
                  )}
                </div>
              </div>
            );
          })}
        </div>
      ) : (
        <div class="flex flex-col items-center justify-center py-3 text-center">
          <span class="text-2xl mb-1">üíâ</span>
          <p class="text-xs text-muted">Sin vacunas</p>
        </div>
      )}
    </a>

    {/* Alimentaci√≥n detalle */}
    <a href="/alimentacion" class="rounded-2xl bg-card border border-card-border p-4 transition-all active:scale-95 hover:shadow-sm hover:border-amber/30">
      <div class="flex items-center justify-between mb-3">
        <p class="text-xs font-semibold text-ink">Alimentaci√≥n</p>
        <svg class="h-4 w-4 text-muted/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>
      {currentFood ? (
        <>
          <div class="flex items-center gap-2 mb-3">
            <div class="flex h-8 w-8 shrink-0 items-center justify-center rounded-xl bg-amber/10">
              <svg class="h-4 w-4 text-amber-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
            </div>
            <p class="text-sm font-bold text-ink truncate">{currentFood.brand}</p>
          </div>
          {avgCostPerDay && (
            <div class="flex items-baseline gap-1">
              <p class="text-xl font-black text-ink">${avgCostPerDay}</p>
              <p class="text-[11px] text-muted">/d√≠a</p>
            </div>
          )}
          {daysLeft !== null && totalDays !== null && (
            <div class="mt-2">
              <div class="flex items-center justify-between mb-1">
                <p class="text-[11px] text-muted">{daysLeft}d restantes de {totalDays}d</p>
                <p class="text-[11px] font-semibold text-ink">{Math.round((daysLeft / totalDays) * 100)}%</p>
              </div>
              <div class="h-1.5 rounded-full bg-card-border overflow-hidden">
                <div
                  class="h-1.5 rounded-full transition-all"
                  style={`width: ${Math.round((daysLeft / totalDays) * 100)}%; background-color: ${daysLeft <= 5 ? '#EF4444' : daysLeft <= 10 ? '#F59E0B' : '#7CB974'};`}
                />
              </div>
            </div>
          )}
        </>
      ) : (
        <div class="flex flex-col items-center justify-center py-3 text-center">
          <span class="text-2xl mb-1">üçñ</span>
          <p class="text-xs text-muted">Agregar alimento</p>
        </div>
      )}
    </a>

  </div>

  {/* ‚îÄ‚îÄ REMINDERS: Antipulgas + Desparasitante ‚îÄ‚îÄ */}
  <a href="/salud/preventivos" class="block mb-5 animate-fade-up animate-fade-up-delay-2">
    <div class="rounded-2xl bg-card border border-card-border overflow-hidden transition-all duration-200 hover:shadow-sm active:scale-95">
      <div class="flex items-center justify-between px-4 py-3 border-b border-card-border">
        <p class="text-xs font-semibold text-muted uppercase tracking-widest">Recordatorios</p>
        <svg class="h-4 w-4 text-muted/40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m9 18 6-6-6-6"/></svg>
      </div>
      <div class="divide-y divide-card-border">

        <div class="flex items-center gap-3 px-4 py-3">
          <div class:list={[
            'flex h-9 w-9 shrink-0 items-center justify-center rounded-xl text-base',
            antipulgasInfo.overdue || !antipulgasInfo.lastDate ? 'bg-red-50' : antipulgasInfo.daysLeft <= 5 ? 'bg-amber/10' : 'bg-green-50'
          ]}>üêõ</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-ink">Antipulgas</p>
            {lastAntipulgas?.[0]?.product_name && (
              <p class="text-[11px] text-muted truncate">{lastAntipulgas[0].product_name}</p>
            )}
          </div>
          <div class="text-right shrink-0">
            {!antipulgasInfo.lastDate ? (
              <p class="text-xs font-semibold text-red-500">Nunca</p>
            ) : antipulgasInfo.overdue ? (
              <p class="text-xs font-semibold text-red-500">Vencido</p>
            ) : antipulgasInfo.daysLeft === 0 ? (
              <p class="text-xs font-semibold text-amber-600">¬°Hoy!</p>
            ) : (
              <p class:list={['text-xs font-semibold', antipulgasInfo.daysLeft <= 5 ? 'text-amber-600' : 'text-accent-dark']}>
                {antipulgasInfo.daysLeft}d
              </p>
            )}
            <p class="text-[10px] text-muted">pr√≥ximo</p>
          </div>
        </div>

        <div class="flex items-center gap-3 px-4 py-3">
          <div class:list={[
            'flex h-9 w-9 shrink-0 items-center justify-center rounded-xl text-base',
            desparasitanteInfo.overdue || !desparasitanteInfo.lastDate ? 'bg-red-50' : desparasitanteInfo.daysLeft <= 5 ? 'bg-amber/10' : 'bg-green-50'
          ]}>üíä</div>
          <div class="flex-1 min-w-0">
            <p class="text-sm font-semibold text-ink">Desparasitante</p>
            {lastDesparasitante?.[0]?.product_name && (
              <p class="text-[11px] text-muted truncate">{lastDesparasitante[0].product_name}</p>
            )}
          </div>
          <div class="text-right shrink-0">
            {!desparasitanteInfo.lastDate ? (
              <p class="text-xs font-semibold text-red-500">Nunca</p>
            ) : desparasitanteInfo.overdue ? (
              <p class="text-xs font-semibold text-red-500">Vencido</p>
            ) : desparasitanteInfo.daysLeft === 0 ? (
              <p class="text-xs font-semibold text-amber-600">¬°Hoy!</p>
            ) : (
              <p class:list={['text-xs font-semibold', desparasitanteInfo.daysLeft <= 5 ? 'text-amber-600' : 'text-accent-dark']}>
                {desparasitanteInfo.daysLeft}d
              </p>
            )}
            <p class="text-[10px] text-muted">pr√≥ximo</p>
          </div>
        </div>

      </div>
    </div>
  </a>

  {/* ‚îÄ‚îÄ QUICK ACTIONS ‚îÄ‚îÄ */}
  <p class="text-xs font-semibold text-muted uppercase tracking-widest mb-3 animate-fade-up animate-fade-up-delay-3">Acciones r√°pidas</p>
  <div class="grid grid-cols-2 gap-3 animate-fade-up animate-fade-up-delay-3">
    <a href="/salud/vacunas" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-accent/30 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-accent/10">
        <svg class="h-4.5 w-4.5 text-accent" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m14.5 2-8.5 8.5v4h4l8.5-8.5a2.83 2.83 0 0 0-4-4z"/><path d="m18 2 4 4"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Vacunas</p>
        <p class="text-[11px] text-muted">Ver historial</p>
      </div>
    </a>
    <a href="/aventuras" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-sky-200 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-sky-50">
        <svg class="h-4.5 w-4.5 text-sky-500" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Nueva foto</p>
        <p class="text-[11px] text-muted">Registrar aventura</p>
      </div>
    </a>
    <a href="/salud/peso" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-amber/30 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-amber/10">
        <svg class="h-4.5 w-4.5 text-amber-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M8 12a4 4 0 0 1 8 0"/><line x1="12" y1="12" x2="12" y2="8"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Peso</p>
        <p class="text-[11px] text-muted">Registrar nuevo</p>
      </div>
    </a>
    <a href="/alimentacion" class="flex items-center gap-3 rounded-2xl bg-card border border-card-border px-4 py-3.5 transition-all duration-200 hover:border-amber/30 hover:shadow-sm active:scale-95">
      <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-xl bg-amber/10">
        <svg class="h-4.5 w-4.5 text-amber-dark" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"/><path d="M7 2v20"/><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3Zm0 0v7"/></svg>
      </div>
      <div>
        <p class="text-sm font-semibold text-ink">Alimentaci√≥n</p>
        <p class="text-[11px] text-muted">Ver dieta</p>
      </div>
    </a>
  </div>

</MainLayout>
