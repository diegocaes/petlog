---
import '../styles/global.css';
import { createSupabaseClient } from '../lib/supabase';

const supabase = createSupabaseClient(Astro.request, Astro.cookies);
const { data: { user } } = await supabase.auth.getUser();

if (user) {
  return Astro.redirect('/dashboard');
}

const error = Astro.url.searchParams.get('error');
const success = Astro.url.searchParams.get('success');

// Handle form submission
if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const email = formData.get('email') as string;
  const password = formData.get('password') as string;
  const action = formData.get('action') as string;

  if (action === 'login') {
    const { error: loginError } = await supabase.auth.signInWithPassword({
      email,
      password,
    });
    if (loginError) {
      return Astro.redirect('/login?error=invalid_credentials');
    }
    return Astro.redirect('/dashboard');
  }

  if (action === 'register') {
    const { error: registerError } = await supabase.auth.signUp({
      email,
      password,
    });
    if (registerError) {
      return Astro.redirect('/login?error=register_failed');
    }
    return Astro.redirect('/login?success=check_email');
  }
}
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="theme-color" content="#166534" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" href="/icons/icon-192.png" />
    <title>Entrar | PetLog</title>
  </head>
  <body class="flex min-h-screen items-center justify-center bg-cream p-4">
    <!-- Decorative background blobs -->
    <div class="fixed inset-0 overflow-hidden pointer-events-none">
      <div class="absolute -top-32 -right-32 h-64 w-64 rounded-full bg-forest/[0.03] blur-3xl"></div>
      <div class="absolute -bottom-32 -left-32 h-64 w-64 rounded-full bg-amber/[0.05] blur-3xl"></div>
    </div>

    <div class="relative w-full max-w-sm">
      <!-- Logo -->
      <div class="mb-8 text-center animate-fade-up">
        <div class="mx-auto mb-4 flex h-20 w-20 items-center justify-center rounded-3xl bg-gradient-to-br from-forest to-forest-dark text-4xl text-white shadow-xl ring-8 ring-forest/10">
          游
        </div>
        <h1 class="text-3xl font-extrabold text-gray-800 tracking-tight">PetLog</h1>
        <p class="mt-2 text-gray-500">El diario digital de tu mascota</p>
        <div class="mt-3 mx-auto h-1 w-12 rounded-full bg-gradient-to-r from-forest to-amber"></div>
      </div>

      <!-- Messages -->
      {error && (
        <div class="mb-4 rounded-2xl bg-red-50 px-4 py-3 text-sm text-red-700 border border-red-100 animate-fade-up">
          {error === 'invalid_credentials' && 'Email o contrase침a incorrectos'}
          {error === 'register_failed' && 'No se pudo crear la cuenta. Intenta con otro email.'}
          {error === 'auth_failed' && 'Error de autenticaci칩n'}
          {error === 'no_code' && 'C칩digo de autenticaci칩n no encontrado'}
        </div>
      )}
      {success === 'check_email' && (
        <div class="mb-4 rounded-2xl bg-green-50 px-4 py-3 text-sm text-green-700 border border-green-100 animate-fade-up">
          춰Cuenta creada! Revisa tu email para confirmar.
        </div>
      )}

      <!-- Login Form -->
      <div class="rounded-3xl bg-white/80 backdrop-blur-xl p-6 sm:p-8 shadow-xl border border-white/60 animate-fade-up animate-fade-up-delay-1">
        <form method="POST" class="space-y-5" id="login-form">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Email</label>
            <input
              type="email"
              name="email"
              required
              placeholder="tu@email.com"
              class="w-full rounded-xl border border-cream-dark bg-white px-4 py-3 text-gray-800 placeholder-gray-400 transition-all duration-200 hover:border-gray-300 focus:border-forest focus:outline-none focus:ring-2 focus:ring-forest/20"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Contrase침a</label>
            <input
              type="password"
              name="password"
              required
              minlength="6"
              placeholder="M칤nimo 6 caracteres"
              class="w-full rounded-xl border border-cream-dark bg-white px-4 py-3 text-gray-800 placeholder-gray-400 transition-all duration-200 hover:border-gray-300 focus:border-forest focus:outline-none focus:ring-2 focus:ring-forest/20"
            />
          </div>

          <div class="flex gap-3 pt-1">
            <button
              type="submit"
              name="action"
              value="login"
              class="flex-1 rounded-2xl bg-forest px-6 py-3.5 font-semibold text-white shadow-md transition-all duration-200 hover:bg-forest-light hover:shadow-lg active:scale-95"
            >
              Entrar
            </button>
            <button
              type="submit"
              name="action"
              value="register"
              class="flex-1 rounded-2xl bg-amber px-6 py-3.5 font-semibold text-gray-900 shadow-md transition-all duration-200 hover:bg-amber-dark hover:shadow-lg active:scale-95"
            >
              Crear cuenta
            </button>
          </div>
        </form>
      </div>

      <p class="mt-8 text-center text-xs text-gray-400">
        Hecho con 仇벒잺 para los amantes de sus mascotas
      </p>
    </div>

    <script>
      // Loading state on login form submit
      const form = document.getElementById('login-form') as HTMLFormElement;
      form?.addEventListener('submit', () => {
        const btns = form.querySelectorAll<HTMLButtonElement>('button[type="submit"]');
        btns.forEach(btn => {
          btn.classList.add('btn-loading');
          btn.setAttribute('disabled', '');
        });
      });
    </script>
  </body>
</html>
