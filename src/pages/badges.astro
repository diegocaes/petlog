---
import MainLayout from '../layouts/MainLayout.astro';
import { getActivePet } from '../lib/pet';
import { evaluateBadges } from '../lib/badges';
import type { BadgeCounts } from '../lib/badges';

const { supabase, user, activePetId } = Astro.locals;
const { pet } = await getActivePet(supabase, user.id, activePetId);

if (!pet) return Astro.redirect('/onboarding');

// Gather all counts in parallel
const [
  { count: vaccineCount },
  { count: visitCount },
  { count: weightCount },
  { count: adventureCount },
  { count: flightCount },
  { count: groomingCount },
  { count: foodCount },
  { data: antipulgasRows },
  { data: desparasitanteRows },
  { data: vaccineNamesRows },
] = await Promise.all([
  supabase.from('vaccines').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('vet_visits').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('weight_records').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('adventures').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('flights').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('groomings').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('foods').select('*', { count: 'exact', head: true }).eq('pet_id', pet.id),
  supabase.from('preventive_treatments').select('id').eq('pet_id', pet.id).eq('type', 'antipulgas').limit(1),
  supabase.from('preventive_treatments').select('id').eq('pet_id', pet.id).eq('type', 'desparasitante').limit(1),
  supabase.from('vaccines').select('name').eq('pet_id', pet.id),
]);

const profileComplete = !!(pet.photo_url && pet.chip_id && pet.color);

const counts: BadgeCounts = {
  profileComplete,
  vaccineCount: vaccineCount ?? 0,
  visitCount: visitCount ?? 0,
  weightCount: weightCount ?? 0,
  adventureCount: adventureCount ?? 0,
  flightCount: flightCount ?? 0,
  groomingCount: groomingCount ?? 0,
  foodCount: foodCount ?? 0,
  hasAntipulgas: (antipulgasRows?.length ?? 0) > 0,
  hasDesparasitante: (desparasitanteRows?.length ?? 0) > 0,
  vaccineNames: (vaccineNamesRows ?? []).map((v: { name: string }) => v.name),
};

const result = evaluateBadges(counts);
const pct = Math.round((result.earnedCount / result.totalCount) * 100);

// Separate earned and locked
const earnedEngagement = result.engagement.filter(b => b.earned);
const lockedEngagement = result.engagement.filter(b => !b.earned);
const earnedVaccines = result.vaccines.filter(v => v.earned);
const lockedVaccines = result.vaccines.filter(v => !v.earned);
---

<MainLayout title="Insignias">
  <!-- Header row: title + progress card -->
  <div class="mb-6 animate-fade-up flex items-start justify-between gap-4">
    <div>
      <h1 class="text-2xl font-black text-ink tracking-tight">Insignias</h1>
      <p class="text-sm text-muted mt-0.5">Logros de {pet.name}</p>
    </div>
    <div class="flex items-center gap-3 rounded-2xl border border-card-border bg-white px-4 py-3 shadow-sm">
      <div class="relative h-11 w-11">
        <svg viewBox="0 0 36 36" class="h-11 w-11 -rotate-90">
          <circle cx="18" cy="18" r="15.5" fill="none" stroke="#EAECF0" stroke-width="3"/>
          <circle
            cx="18" cy="18" r="15.5"
            fill="none"
            stroke="var(--color-accent)"
            stroke-width="3"
            stroke-linecap="round"
            stroke-dasharray={`${(pct / 100) * 97.4} 97.4`}
          />
        </svg>
        <div class="absolute inset-0 flex items-center justify-center">
          <span class="text-xs font-black text-ink">{pct}%</span>
        </div>
      </div>
      <div>
        <p class="text-lg font-black text-ink leading-tight">{result.earnedCount}<span class="text-sm font-medium text-muted">/{result.totalCount}</span></p>
        <p class="text-xs text-muted">desbloqueados</p>
      </div>
    </div>
  </div>

  <!-- Earned badges -->
  {(earnedEngagement.length > 0 || earnedVaccines.length > 0) && (
    <div class="mb-8 animate-fade-up animate-fade-up-delay-1">
      <div class="flex items-center gap-2 mb-4">
        <h2 class="text-xs font-bold text-muted uppercase tracking-widest">Desbloqueados</h2>
        <span class="text-xs text-muted font-medium ml-auto">{result.earnedCount}</span>
      </div>
      <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
        {earnedEngagement.map(badge => (
          <div class="flex flex-col items-center gap-2 px-2 py-3 cursor-default" title={badge.description}>
            <img src={`/badges/${badge.img}`} alt={badge.name} class="h-16 w-16 object-contain drop-shadow-lg" />
            <p class="text-xs font-semibold text-ink leading-tight text-center">{badge.name}</p>
          </div>
        ))}
        {earnedVaccines.map(vac => (
          <div class="flex flex-col items-center gap-2 px-2 py-3 cursor-default" title={`Vacuna: ${vac.name}`}>
            <img src={`/badges/${vac.img}`} alt={vac.name} class="h-16 w-16 object-contain drop-shadow-lg" />
            <div class="text-center">
              <p class="text-xs font-semibold text-ink leading-tight">{vac.name}</p>
              <p class="text-2xs text-muted">Vacuna</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  )}

  <!-- Locked badges -->
  {(lockedEngagement.length > 0 || lockedVaccines.length > 0) && (
    <div class="mb-8 animate-fade-up animate-fade-up-delay-2">
      <div class="flex items-center gap-2 mb-4">
        <h2 class="text-xs font-bold text-muted uppercase tracking-widest">Por desbloquear</h2>
        <span class="text-xs text-muted font-medium ml-auto">{lockedEngagement.length + lockedVaccines.length}</span>
      </div>
      <div class="grid grid-cols-3 sm:grid-cols-4 gap-4">
        {lockedEngagement.map(badge => (
          <div class="flex flex-col items-center gap-2 px-2 py-3 group cursor-default" title={badge.description}>
            <div class="relative">
              <img src={`/badges/${badge.img}`} alt={badge.name} class="h-16 w-16 object-contain grayscale opacity-20" />
              <div class="absolute inset-0 flex items-center justify-center">
                <svg class="h-4 w-4 text-muted/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              </div>
            </div>
            <p class="text-xs font-semibold text-muted leading-tight text-center">{badge.name}</p>
          </div>
        ))}
        {lockedVaccines.map(vac => (
          <a href="/salud/vacunas?new=1" class="flex flex-col items-center gap-2 px-2 py-3 rounded-2xl transition-all hover:bg-accent/5 active:scale-95" title={`Registra la vacuna de ${vac.name}`}>
            <div class="relative">
              <img src={`/badges/${vac.img}`} alt={vac.name} class="h-16 w-16 object-contain grayscale opacity-20" />
              <div class="absolute inset-0 flex items-center justify-center">
                <svg class="h-4 w-4 text-muted/30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
              </div>
            </div>
            <div class="text-center">
              <p class="text-xs font-semibold text-muted leading-tight">{vac.name}</p>
              <p class="text-2xs text-accent">Registrar →</p>
            </div>
          </a>
        ))}
      </div>
    </div>
  )}

  <p class="mt-10 mb-4 text-center text-xs text-muted/40 leading-relaxed max-w-xs mx-auto">Gana insignias completando acciones con {pet.name}. Cada logro se desbloquea automáticamente cuando cumples la condición.</p>
</MainLayout>
